<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Mixture of K scaled and shifted t-distributions – My sparse website</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">My sparse website</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../projects.html"> 
<span class="menu-text">Projects</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../applications.html"> 
<span class="menu-text">Applications</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduktion" id="toc-introduktion" class="nav-link active" data-scroll-target="#introduktion">Introduktion</a></li>
  <li><a href="#a-littel-theory" id="toc-a-littel-theory" class="nav-link" data-scroll-target="#a-littel-theory">A littel theory</a>
  <ul class="collapse">
  <li><a href="#posterior-probabilities-expectation-step" id="toc-posterior-probabilities-expectation-step" class="nav-link" data-scroll-target="#posterior-probabilities-expectation-step">Posterior probabilities (Expectation step)</a></li>
  <li><a href="#maximization-step-m-step" id="toc-maximization-step-m-step" class="nav-link" data-scroll-target="#maximization-step-m-step">Maximization step M step:</a></li>
  </ul></li>
  <li><a href="#log-likelyhood" id="toc-log-likelyhood" class="nav-link" data-scroll-target="#log-likelyhood">Log Likelyhood</a>
  <ul class="collapse">
  <li><a href="#solving-the-lagrancian." id="toc-solving-the-lagrancian." class="nav-link" data-scroll-target="#solving-the-lagrancian.">Solving the lagrancian.</a></li>
  <li><a href="#estiamtion-of-theta_kmu_ksigma_knu_k" id="toc-estiamtion-of-theta_kmu_ksigma_knu_k" class="nav-link" data-scroll-target="#estiamtion-of-theta_kmu_ksigma_knu_k">Estiamtion of <span class="math inline">\(\theta_k=\{\mu_k,\sigma_k,\nu_k\}\)</span></a></li>
  </ul></li>
  <li><a href="#gradient-of-theta_k" id="toc-gradient-of-theta_k" class="nav-link" data-scroll-target="#gradient-of-theta_k">Gradient of <span class="math inline">\(\theta_k\)</span></a></li>
  <li><a href="#finding-the-gradient-of-negativ-log-likelyhood-for-nu_k" id="toc-finding-the-gradient-of-negativ-log-likelyhood-for-nu_k" class="nav-link" data-scroll-target="#finding-the-gradient-of-negativ-log-likelyhood-for-nu_k">Finding the gradient of negativ log likelyhood for <span class="math inline">\(\nu_k\)</span></a>
  <ul class="collapse">
  <li><a href="#finding-the-gradient-of-negativ-log-likelyhood-for-sigma_k" id="toc-finding-the-gradient-of-negativ-log-likelyhood-for-sigma_k" class="nav-link" data-scroll-target="#finding-the-gradient-of-negativ-log-likelyhood-for-sigma_k">Finding the gradient of negativ log likelyhood for <span class="math inline">\(\sigma_k\)</span></a></li>
  </ul></li>
  <li><a href="#gradient-decent." id="toc-gradient-decent." class="nav-link" data-scroll-target="#gradient-decent.">Gradient decent.</a>
  <ul class="collapse">
  <li><a href="#undershooting-the-gradient-out-of-domain." id="toc-undershooting-the-gradient-out-of-domain." class="nav-link" data-scroll-target="#undershooting-the-gradient-out-of-domain.">Undershooting the gradient out of domain.</a></li>
  <li><a href="#gradient-explotion" id="toc-gradient-explotion" class="nav-link" data-scroll-target="#gradient-explotion">Gradient explotion</a></li>
  <li><a href="#normalising-the-gradient" id="toc-normalising-the-gradient" class="nav-link" data-scroll-target="#normalising-the-gradient">Normalising the gradient</a></li>
  <li><a href="#gradient-clipping" id="toc-gradient-clipping" class="nav-link" data-scroll-target="#gradient-clipping">Gradient clipping</a>
  <ul class="collapse">
  <li><a href="#implentatsion-notes-for-gradient-decent" id="toc-implentatsion-notes-for-gradient-decent" class="nav-link" data-scroll-target="#implentatsion-notes-for-gradient-decent">Implentatsion notes for gradient decent</a></li>
  </ul></li>
  <li><a href="#combining-it-all-to-one-em-function." id="toc-combining-it-all-to-one-em-function." class="nav-link" data-scroll-target="#combining-it-all-to-one-em-function.">Combining it all to one EM function.</a></li>
  <li><a href="#initialization" id="toc-initialization" class="nav-link" data-scroll-target="#initialization">Initialization</a></li>
  </ul></li>
  <li><a href="#potential-problems" id="toc-potential-problems" class="nav-link" data-scroll-target="#potential-problems">Potential problems</a>
  <ul class="collapse">
  <li><a href="#gridsearch-initialization" id="toc-gridsearch-initialization" class="nav-link" data-scroll-target="#gridsearch-initialization">GridSearch Initialization</a></li>
  </ul></li>
  <li><a href="#measurs" id="toc-measurs" class="nav-link" data-scroll-target="#measurs">Measurs</a></li>
  <li><a href="#code" id="toc-code" class="nav-link" data-scroll-target="#code">Code</a></li>
  <li><a href="#test" id="toc-test" class="nav-link" data-scroll-target="#test">Test</a></li>
  <li><a href="#a-look-into-when-initialization-fails" id="toc-a-look-into-when-initialization-fails" class="nav-link" data-scroll-target="#a-look-into-when-initialization-fails">A Look into When Initialization Fails</a>
  <ul class="collapse">
  <li><a href="#test-with-second-initialization" id="toc-test-with-second-initialization" class="nav-link" data-scroll-target="#test-with-second-initialization">Test with second initialization</a></li>
  <li><a href="#why-the-initialization-fails." id="toc-why-the-initialization-fails." class="nav-link" data-scroll-target="#why-the-initialization-fails.">Why the initialization fails.</a></li>
  </ul></li>
  <li><a href="#aplicantion-on-real-data" id="toc-aplicantion-on-real-data" class="nav-link" data-scroll-target="#aplicantion-on-real-data">Aplicantion on real data</a></li>
  <li><a href="#further-improvements" id="toc-further-improvements" class="nav-link" data-scroll-target="#further-improvements">Further improvements</a>
  <ul class="collapse">
  <li><a href="#model-selection" id="toc-model-selection" class="nav-link" data-scroll-target="#model-selection">Model selection</a></li>
  <li><a href="#confidence-bands" id="toc-confidence-bands" class="nav-link" data-scroll-target="#confidence-bands">confidence bands</a>
  <ul class="collapse">
  <li><a href="#initialization-1" id="toc-initialization-1" class="nav-link" data-scroll-target="#initialization-1">Initialization</a></li>
  <li><a href="#gradient-decent.-1" id="toc-gradient-decent.-1" class="nav-link" data-scroll-target="#gradient-decent.-1">Gradient decent.</a></li>
  </ul></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Mixture of K scaled and shifted t-distributions</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="introduktion" class="level1">
<h1>Introduktion</h1>
<p>In this project, I will examine a mixture of K scaled and shifted t-distributions.</p>
<p>The scaled and shifted t-distributions have the following PDF. <span class="math display">\[
f(x|\mu,\sigma,\nu)=\frac{\Gamma((\nu+1)/2)}{\sqrt{\pi\nu\sigma^2}\Gamma(\nu/2)}(1+\frac{(x-\mu)^2}{\nu\sigma^2})^{-(\nu+1)/2}
\]</span></p>
<p><span class="math inline">\(\mu\in     \mathbb{R}\)</span>, <span class="math inline">\(\sigma&gt;0\)</span> and <span class="math inline">\(\nu&gt;0\)</span></p>
<p>With the mixed distribution.</p>
<p><span class="math display">\[\sum_{k=1}^{K} \pi_k f(x|\mu_k,\sigma_k,\nu_k)\]</span></p>
</section>
<section id="a-littel-theory" class="level1">
<h1>A littel theory</h1>
<p>The EM algorithm consists of a two-step optimization process to maximize the likelihood. In the Expectation (E) step, the posterior probabilities are calculated. In the Maximization (M) step, the likelihood is maximized to find the parameters, given the posterior probabilities.</p>
<section id="posterior-probabilities-expectation-step" class="level2">
<h2 class="anchored" data-anchor-id="posterior-probabilities-expectation-step">Posterior probabilities (Expectation step)</h2>
<p>The posterior probabilities correspond to the probability that an outcome is drawn from a given distribution. <span class="math display">\[
P(Z=\pi_k|x_i)=\frac{P(x_i|Z=\pi_k)P(Z_i=\pi_k)}{P(x_i)}=\frac{\pi_kf(x_i|\mu_k,\sigma_k,\nu_k)}{\sum_{k=1}^{K}{\pi_k}f(x_i|\mu_k,\sigma_k,\nu_k)}=w(x_i)
\]</span></p>
</section>
<section id="maximization-step-m-step" class="level2">
<h2 class="anchored" data-anchor-id="maximization-step-m-step">Maximization step M step:</h2>
<p>In the M step, the coefficients <span class="math inline">\(\{\pi_k,\theta_k\}\)</span> are estimated, where <span class="math inline">\(\theta_k=\{\mu_k,\sigma_k,\nu_k\}\)</span></p>
</section>
</section>
<section id="log-likelyhood" class="level1">
<h1>Log Likelyhood</h1>
<p>The simplification of writing makes it possible to express the density in the form <span class="math inline">\(f(x|\pi,\theta)\sum_{k=1}^K \pi_kf(x|\theta_k)\)</span> where <span class="math inline">\(\theta_i=\{\mu_i,\sigma_i^2,\nu_i\}\)</span>.</p>
<p>Making the the likelihood <span class="math display">\[
L(\pi_k,\theta_k)=\sum_{i=1}^{N}\sum_{k=1}^{K}\pi_kf(x_i|\theta_k)
\]</span></p>
<p>and the negative log likelihood. <span class="math display">\[
l(\pi_k,\theta_k)=-\sum_{i=1}^{N} log(\sum_{k=1}^{K}\pi_kf(x_i|\theta_k))
\]</span></p>
<p>For the estimation of <span class="math inline">\(\pi_k\)</span> Lagrange optimization can be used on the negative log-likelihood. It should be noted that <span class="math inline">\(\sum_{k=1}^{K}\pi_k =1\)</span>. corresponds to the linear constraint.</p>
<p>The Lagrange function becomes <span class="math display">\[
\mathcal{L}(\pi_k)=-\sum_{i=1}^{N} log(\sum_{k=1}^{K}\pi_kf(x_i|\theta_k))-(\lambda\sum_{k=1}^{K}\pi_k-1)
\]</span></p>
<p>Lagrange optimization requires the objective function to be convex. Convexity can be checked using the second derivative.</p>
<p>Fist derivative. <span class="math display">\[
\frac{\partial l(\pi_k,\theta_k)}{\partial \pi_k}=-\sum_{i=1}^{n}\frac{f(x_i|\theta_k)}{\sum_{k=1}^{K}\pi_kf(x_i|\theta_k)}
\]</span></p>
<p>Second derivative. <span class="math display">\[
\frac{\partial^2 l(\pi_k,\theta_k)}{\partial^2 \pi_k}=\sum_{i=1}^{n}\frac{f(x_i|\theta_k)^2}{(\sum_{k=1}^{K}\pi_kf(x_i|\theta_k))^2}&gt;0
\]</span></p>
<p>Since the second derivative of the negative log-likelihood is positive for all values of <span class="math inline">\(X\)</span>, the function is convex. This follows from the fact that <span class="math inline">\(f(x_i,\theta_k),\pi_k&gt;0\)</span> by the definition of probabilities.</p>
<section id="solving-the-lagrancian." class="level3">
<h3 class="anchored" data-anchor-id="solving-the-lagrancian.">Solving the lagrancian.</h3>
<p><span class="math display">\[
\mathcal{L}(\pi_k)=-\sum_{i=1}^{N} log(\sum_{k=1}^{K}\pi_kf(x_i|\theta_k))-(\lambda\sum_{k=1}^{K}\pi_k-1)
\]</span></p>
<p>Fist derivative. <span class="math display">\[
\frac{\partial\mathcal{L}(\pi_k)}{\partial \pi_k}=\sum_{i=1}^{N}\frac{f(x_i|\theta_k)}{\sum_{k=1}^{K}\pi_kf(x_i|\theta_k)} +\lambda =\sum_{i=1}^{N}w(x_i)\frac{1}{\pi_k} +\lambda =0
\]</span></p>
<p>The left side is the same as the weight, which is the posterior probabilities multiplied by <span class="math inline">\(\pi_k\)</span>.</p>
<p>This gives a condition for the optimal value. <span class="math display">\[
\sum_{i=1}^{N}w(x_i)+\pi_k\lambda = 0 =&gt; -\frac{1}{\pi_k}\sum_{i=1}^{N}w(x_i) =\lambda
\]</span></p>
<p>But since <span class="math inline">\(\sum_{i=1}^{N}w(x_i)+\pi_k\lambda = 0\)</span> must hold for all <span class="math inline">\(k\)</span> and that <span class="math inline">\(\sum_{k=1}^{K}w(x_i)=1\)</span>, since these are the posterior probabilities. One can derive. <span class="math display">\[
\begin{aligned}
0=\sum_{k=1}^{K}(\sum_{i=1}^{N}w(x_i)+\pi_k\lambda )=\sum_{k=1}^{K}\sum_{i=1}^{N}w(x_i)+\sum_{k=1}^{K}\pi_k\lambda =\sum_{k=1}^{K}\sum_{i=1}^{N}w(x_i)+\lambda \\ = \sum_{k=1}^{K}\sum_{i=1}^{N}w(x_i) -\frac{1}{\pi_k}\sum_{i=1}^{N}w(x_i)=\sum_{i=1}^{N}\sum_{k=1}^{K}w(x_i)
-\frac{1}{\pi_k}\sum_{i=1}^{N}w(x_i) \\
\sum_{i=1}^{N}\sum_{k=1}^{K}w(x_i)
-\frac{1}{\pi_k}\sum_{i=1}^{N}w(x_i)=N-\frac{1}{\pi_k}\sum_{i=1}^{N}w(x_i)\\ =&gt; \hat{\pi}_k= \frac{1}{N}\sum_{i=1}^{N}w(x_i)
\end{aligned}
\]</span></p>
<p>The estimate for the probability of drawing from a given distribution is the average of the weights.</p>
</section>
<section id="estiamtion-of-theta_kmu_ksigma_knu_k" class="level2">
<h2 class="anchored" data-anchor-id="estiamtion-of-theta_kmu_ksigma_knu_k">Estiamtion of <span class="math inline">\(\theta_k=\{\mu_k,\sigma_k,\nu_k\}\)</span></h2>
<p>The estimation of the parameters <span class="math inline">\(\theta_k={\mu_k,\sigma_k,\nu_k}\)</span> is done by minimizing the negative log-likelihood.</p>
<p>As demonstrated below, the problem is that there is no closed-form solution. This arises from the fact that there is a sum in the denominator of the gradient.</p>
</section>
</section>
<section id="gradient-of-theta_k" class="level1">
<h1>Gradient of <span class="math inline">\(\theta_k\)</span></h1>
<p><span class="math display">\[
\frac{\partial l(\theta_k)  }{\partial \theta_k} =- \sum_{i=1}^{N}\frac{\pi_k}{\sum_{k}^{K}\pi_{k}f(x_i|\theta_k)}\frac{\partial f(x_i|\theta_k)  }{\partial \theta_k}
\]</span></p>
<p>Note that in the above, it is almost the sum of the weights, so it can be useful to express<span class="math inline">\(\frac{\partial f(x_i|\theta_k)}{\partial\theta_k}\)</span> in terms of <span class="math inline">\(f(x_i|\theta_k)\)</span>, if possible.</p>
<p>Since <span class="math inline">\(\theta_k\)</span> is a simplified notation for the parameters <span class="math inline">\(\{\mu_k,\sigma_k,\nu_k\}\)</span>, which are the parameters of interest to estimate, the derivatives with respect to these parameters will be calculated and substituted into the formula above.</p>
<p>In the next section, <span class="math inline">\(\frac{\partial f(x_i|\theta_k)  }{\partial \theta_k}\)</span> will be found with respect to <span class="math inline">\(\{\mu_k,\sigma_k,\nu_k\}\)</span> and substituted into <span class="math inline">\(\frac{\partial l(\theta_k)  }{\partial \theta_k}\)</span> to give a formula for <span class="math inline">\(\frac{\partial l(\theta_k)  }{\partial \theta_k}\)</span> to provide a formula for <span class="math inline">\(\frac{\partial l(\theta_k)  }{\partial \theta_k}\)</span>.</p>
</section>
<section id="finding-the-gradient-of-negativ-log-likelyhood-for-nu_k" class="level1">
<h1>Finding the gradient of negativ log likelyhood for <span class="math inline">\(\nu_k\)</span></h1>
<p><span class="math display">\[
\begin{aligned}
\frac{\partial f(x_i|\mu_k,\sigma_k,\nu_k)}{\partial \mu_k}=(\nu_k+1)(\frac{x_i-\mu_k}{\nu_k\sigma_k^2})(1+\frac{(x_i-\mu_k)^2}{\nu_k\sigma_k^2})^{-1}f(x_i|\mu_k,\sigma_k^2,\nu_k)\\ =(\nu_k+1)\frac{x_i-\mu_k}{\nu_k\sigma_k^2+(x_i-\mu_k)^2}f(x_i|\mu_k,\sigma_k,\nu_k)
\end{aligned}
\]</span></p>
<p>Leading to.</p>
<p><span class="math display">\[
\begin{aligned}
\frac{\partial l(\mu_k,\sigma_k,\nu_k)  }{\partial \mu_k} =- \sum_{i=1}^{N}\frac{\pi_k}{\sum_{k}^{K}\pi_{k}f(x_i|\mu_k,\sigma_k^2,\nu_k)}\frac{\partial f(x_i|\mu_k,\sigma_k,\nu_k)  }{\partial \mu_k}\\ =-(\nu_k+1)\sum_{i=1}^{N}w(x_i)\frac{x_i-\mu_k}{\nu_k\sigma_k^2+(x_i-\mu_k)^2}
\end{aligned}
\]</span></p>
<p>Note that a closed form does not seem possible since <span class="math inline">\(x_i\)</span> appears in the denominator, and the sum cannot be split. However, the gradient can still be used for faster implementation.</p>
<section id="finding-the-gradient-of-negativ-log-likelyhood-for-sigma_k" class="level2">
<h2 class="anchored" data-anchor-id="finding-the-gradient-of-negativ-log-likelyhood-for-sigma_k">Finding the gradient of negativ log likelyhood for <span class="math inline">\(\sigma_k\)</span></h2>
<p><span class="math display">\[
\frac{\partial l(\mu_k,\sigma_k,\nu_k)  }{\partial \sigma_k} =- \sum_{i=1}^{N}\frac{\pi_k}{\sum_{k}^{K}\pi_{k}f(x_i|\mu_k,\sigma_k\nu_k)}\frac{\partial f(x_i|\mu_k,\sigma_k,\nu_k)  }{\partial \sigma_k}
\]</span></p>
<p><span class="math display">\[
\begin{aligned}
\frac{\partial f(x_i|\mu_k,\sigma_k,\nu_k)  }{\partial \sigma_k}=\frac{-1}{\sigma}f(x_i|\mu_k,\sigma_k,\nu_k)+\frac{(\nu_k+1)(x-\mu_k)^2}{\nu_k\sigma_k^3}\frac{\nu_k\sigma_k^2}{\nu_k\sigma_k^2+(x-\mu_k)^2}f(x_i|\mu_k,\sigma_k,\nu_k)=\\
\frac{1}{\sigma_k}f(x_i|\mu_k,\sigma_k,\nu_k)(-1+\frac{(v_k+1)(x_i-\mu_k)^2}{\nu_k\sigma_k +(x_i-\mu_k)^2})
\end{aligned}
\]</span></p>
<p>This leads to the gradient</p>
<p><span class="math display">\[
\frac{\partial l(\mu_k,\sigma_k,\nu_k)  }{\partial \sigma_k} = -\sum_{i=1}^{N}w(x_i)(-1+\frac{(\nu_k+1)(x_i-\mu_k)^2}{\nu_k\sigma_k +(x_i-\mu_k)^2})\frac{1}{\sigma_k}
\]</span></p>
<p>Since the denominator cannot be split, the expression cannot be simplified.</p>
<p><span class="math display">\[
\frac{\partial l(\mu_k,\sigma_k,\nu_k)}{\partial \nu_k}=- \sum_{i=1}^{N}\frac{\pi_k}{\sum_{k}^{K}\pi_{k}f(x_i|\mu_i,\sigma_i\nu_i)} \frac{\partial f(x|\mu_k,\sigma_k,\nu_k) }{\partial \nu_k}
\]</span></p>
<p>It can be useful to know that <span class="math display">\[
\begin{aligned}
\frac{\partial \frac{\Gamma((\nu_k+1)/2)}{\Gamma(\nu_k/2)}}{\partial \nu} = \frac{\psi((\nu_k+1)/2)}{2\Gamma(\nu_k/2)}-\frac{\Gamma((\nu_k+1)/2)}{2\Gamma(\nu_k/2)^2}\psi(\nu_k/2)\\ =\frac{\psi((\nu_k+1)/2)}{2\Gamma((\nu_k+1)/2)}\frac{\Gamma((\nu_k+1)/2)}{\Gamma(\nu_k/2)}-\frac{\psi(\nu_k/2)}{2\Gamma(\nu_k/2)}\frac{\Gamma((\nu_k+1)/2)}{\Gamma(\nu_k/2)}
\end{aligned}
\]</span></p>
<p>Giving the derivative.</p>
<p><span class="math display">\[
\begin{align*}
\frac{\partial f(x_i|\mu_k,\sigma_k^2,\nu_k) }{\partial \nu_k}=-\frac{1}{2\nu_k}\frac{\Gamma((\nu_k+1)/2)}{\sqrt{\pi\nu_k\sigma_k^2}\Gamma(\nu_k/2)}(1+\frac{(x_i-\mu_k)^2}{\nu_k\sigma_k^2})^{\frac{-(\nu_k+1)}{2}}\\
+\frac{(x_i-\mu_k)^2(\nu_k+1)}{\nu_k\sigma^2+(x_i-\mu_k)^2}\frac{1}{2\nu_k}\frac{\Gamma((\nu_k+1)/2)}{\sqrt{\pi\nu_k\sigma_k^2}\Gamma(\nu_k/2)}(1+\frac{(x_i-\mu_k)^2}{\nu_k\sigma_k^2})^{\frac{-(\nu_k+1)}{2}-1}
\\
+\frac{\partial \frac{\Gamma((\nu_k+1)/2)}{\Gamma(\nu_k/2)}}{\partial \nu_k}\frac{1}{\sqrt{\pi\nu_k\sigma_k^2}}(1+\frac{(x_i-\mu_k)^2}{\nu_k \sigma_k^2})^{\frac{-(\nu_k+1)}{2}}
\\ = \\
-\frac{1}{2\nu_k}f(x_i|\mu_k,\sigma_k^2,\nu_k)\\
+\frac{(x_i-\mu_k)^2(\nu_k+1)}{\nu_k\sigma_k^2+(x_i-\mu_k)^2}\frac{1}{2\nu_k}f(x|\mu_k,\sigma_k^2,\nu_k)
\\
\\ +\frac{\psi((\nu_k+1)/2)}{2\Gamma((\nu_k+1)/2)}\frac{\Gamma((\nu_k+1)/2)}{\Gamma(\nu_k/2)}\frac{1}{\sqrt{\pi\nu_k\sigma_k^2}}(1+\frac{(x_i-\mu_k)^2}{\nu_k\sigma_k^2})^{-\frac{\nu_k+1}{2}}\\
-\frac{\psi(\nu_k/2)}{2\Gamma(\nu_k/2)}\frac{\Gamma((\nu_k+1)/2)}{\Gamma(\nu_k/2)}\frac{1}{\sqrt{\pi\nu_k\sigma_k^2}}(1+\frac{(x_i-\mu_k)^2}{\nu_k\sigma_k^2})^{-\frac{\nu_k+1}{2}}\\
=\\
-\frac{1}{2\nu_k}f(x_i|\mu_k,\sigma_k^2,\nu_k)\\
+\frac{(x_i-\mu_k)^2(\nu_k+1)}{\nu_k\sigma^2+(x_i-\mu_k)^2}\frac{1}{2\nu_k}f(x_i|\mu_k,\sigma_k^2,\nu_k)\\
+\frac{\psi((\nu_k+1)/2)}{2\Gamma((\nu_k+1)/2)}f(x_i|\mu_k,\sigma_k^2,\nu_k)-\frac{\psi(\nu_k/2)}{2\Gamma(\nu_k/2)}f(x_i|\mu_k,\sigma_k^2,\nu_k)
\end{align*}
\]</span></p>
<p>Giving the gradient of the likelihood.</p>
<p><span class="math display">\[
\begin{aligned}
\frac{\partial l(\mu_k,\sigma_k,\nu_k)}{\partial \nu_k}=- \sum_{i=1}^{N}\frac{\pi_k}{\sum_{k}^{K}\pi_{k}f(x_i|\mu_i,\sigma_i\nu_i)} \frac{\partial f(x_i|\mu_k,\sigma_k^2,\nu_k) }{\partial \nu_k}\\ =
-\sum_{i=1}^{N}\frac{-1}{2}w(x_i)+\frac{(\nu_k+1)}{2}\frac{(x_i-\mu_k)^2}{ \nu_k^2\sigma_k^2}w(x_i)+\frac{\psi((\nu+1)/2)}{2\Gamma((\nu+1)/2)}w(x_i)-\frac{\psi(\nu/2)}{2\Gamma(\nu/2)}w(x_i)\\
\end{aligned}
\]</span></p>
<p>All the gradients are computed. The goal is to obtain the maximum likelihood, but there is no closed-form solution. For some special cases, the functions might be approximated nicely. However, the gradients can still be used for gradient descent, which is the method I have chosen.</p>
</section>
</section>
<section id="gradient-decent." class="level1">
<h1>Gradient decent.</h1>
<p>Gradient descent is used in the M step to optimize the parameters given the weights.</p>
<p>Two problems arise when using gradient descent. These are described below.</p>
<section id="undershooting-the-gradient-out-of-domain." class="level2">
<h2 class="anchored" data-anchor-id="undershooting-the-gradient-out-of-domain.">Undershooting the gradient out of domain.</h2>
<p>If gradient descent undershoots and sets <span class="math inline">\(\nu_i&lt;0\)</span> ore <span class="math inline">\(\sigma_i&lt;0\)</span>, the density is not defined. This is handled by setting a minimum value for the parameters <span class="math inline">\(\nu_i\)</span> and <span class="math inline">\(\sigma_i\)</span>. This means that the minimum value for these parameters is not zero but a value close to zero.</p>
<p>Undershooting can also cause problems when using built-in optimization tools. A pro tip is that if you encounter NaN values as output during optimization, it’s a good idea to start debugging with this issue in mind. In my experience, there is not always a built-in check for these cases.</p>
</section>
<section id="gradient-explotion" class="level2">
<h2 class="anchored" data-anchor-id="gradient-explotion">Gradient explotion</h2>
<p>This does not fix the problem of gradient explosion. What happens is that the gradient decent may take too large a step in either direction. To make matters worse, the sum in the expression for the gradients can cause the gradients to grow as the sample size increases, which can lead to gradient explosion.</p>
<p>To combat this, I have tried different strategies. Below are the two method i tried described.</p>
</section>
<section id="normalising-the-gradient" class="level2">
<h2 class="anchored" data-anchor-id="normalising-the-gradient">Normalising the gradient</h2>
<p>When analyzing the gradient, it’s important to note that the sum is not divided by the size of <span class="math inline">\(X\)</span>(denoted as <span class="math inline">\(N\)</span>). This means that the absolute value of the gradient grows with <span class="math inline">\(N\)</span>. If gradient descent is used with a fixed learning rate <span class="math inline">\(\alpha\)</span>, problems may arise where the gradient either undershoots or overshoots. In an implementation setting, this issue is very apparent. However, in real-world problems where the true parameters are unknown, it is impossible to know if the estimated values are accurate.</p>
<p>There are two methods to address this issue: one is to check the norm of the gradient to see if you are near a local optimum, and the other is to increase the number of iterations. I have chosen to normalize the gradient by dividing by <span class="math inline">\(N\)</span>. This corresponds to choosing <span class="math inline">\(\alpha\)</span> based on the size of <span class="math inline">\(X\)</span>.</p>
</section>
<section id="gradient-clipping" class="level2">
<h2 class="anchored" data-anchor-id="gradient-clipping">Gradient clipping</h2>
<p>Gradient clipping works by setting a maximum value for the norm of the gradient. Specifically, if <span class="math inline">\(|\nabla l(X,\pi,\theta)|&gt;c\)</span> then the gradient is scaled to <span class="math inline">\(\nabla l=c*\frac{\nabla l}{|\nabla l|}\)</span>. This allows you to set a maximum value for the norm of the gradient step.</p>
<p>Since this method is based on the norm of the entire gradient, it would be beneficial to vary the clipping based on the type of parameter <span class="math inline">\(\{\mu,\sigma,\nu\}\)</span>., especially for <span class="math inline">\(\mu\)</span>. I have implemented a version where the clipping is based on different parameters.</p>
<p>In testing, it seems that gradient clipping is easy to use and works better. Therefore, in the implementation, gradient clipping is used.</p>
<p>Below is a summary of the gradient descent approach #Gradient decent. Gradient descent is used in the M step to optimize the parameters given the weights.</p>
<p>There is no closed-form solution for many of the gradients. To make matters worse, the sum in the expression for the gradients can cause the gradients to grow as the sample size increases, potentially leading to exploding gradients. If gradient descent undershoots and sets <span class="math inline">\(\nu_i&lt;0\)</span> or <span class="math inline">\(\sigma_i&lt;0\)</span>, the density is not defined. I have addressed the issue of undershooting by setting a minimum value for the parameters <span class="math inline">\(\nu_i\)</span> and <span class="math inline">\(\sigma_i\)</span>. This means that the minimum is not zero but a value close to zero.</p>
<p>However, this does not solve the problem of overshooting gradients. The solution to this issue is normalization. One strategy is to normalize the gradient by the sample size N. Another solution is to use gradient clipping. Gradient clipping works by setting a maximum value for the norm of the gradient. Specifically, if <span class="math inline">\(|\nabla l|&gt;c\)</span>, then the gradient is set to <span class="math inline">\(\nabla l=c*\frac{\nabla l}{|\nabla l|}\)</span>. This allows you to set a maximum value for the norm of the gradient step. Since this method is based on the norm of the entire gradient, it would be beneficial to vary the clipping based on the type of parameter <span class="math inline">\(\{\mu,\sigma,\nu\}\)</span>, especially for <span class="math inline">\(\mu\)</span>.</p>
<p>I have implemented a version where the clipping is based on different parameter types. Specifically, if the gradient matrix column corresponding to a given parameter is normalized by its corresponding vector and scaled by a given constant for that parameter. If this explanation is confusing, refer to the function Gradient_clipping_vec in the Rcpp file, which is fairly self-explanatory.</p>
<p>Additionally, I have included a check to see if a steep step leads to smaller values in the objective function. If not, the gradient is scaled again by <span class="math inline">\(\alpha\)</span>.</p>
<section id="implentatsion-notes-for-gradient-decent" class="level3">
<h3 class="anchored" data-anchor-id="implentatsion-notes-for-gradient-decent">Implentatsion notes for gradient decent</h3>
<p>Since the EM algorithm is an iterative process and R handles loops poorly, Rcpp is used to run C++ code for faster implementation. This is a common approach in many libraries.</p>
</section>
</section>
<section id="combining-it-all-to-one-em-function." class="level2">
<h2 class="anchored" data-anchor-id="combining-it-all-to-one-em-function.">Combining it all to one EM function.</h2>
<p>Since the EM algorithm is a two-step optimization process, it is not strictly necessary to find the smallest value in the M step. The critical aspect is that both steps lead to a decrease in the negative likelihood.</p>
<p>In terms of implementation, this affects the settings used for running gradient descent. For example, setting a maximum number of iterations too high can result in very long runtimes.</p>
<p>I have not found any definitive guidelines for tuning these parameters in general settings, so I have made it possible for the end user to adjust them as needed.</p>
</section>
<section id="initialization" class="level2">
<h2 class="anchored" data-anchor-id="initialization">Initialization</h2>
<p>The EM algorithm requires starting parameters, and if they are too far off, it can affect the runtime. I have chosen to use the hard clustering technique, k-means++, which provides a set of partitions. In each of these partitions, the scaled and shifted t-distributions are fitted and used as the starting parameters.</p>
<p>K-means++ works similarly to k-means, with the primary difference being in the initialization process. The goal of k-means is to minimize the objective function:</p>
<p><span class="math inline">\(\underset{\mu}{\arg\min}\sum_{k=1}^{K}\sum_{i=1}^{N}|x_i-\mu_k|^2\)</span> K-means++ improves on this by initially selecting one center randomly and then iteratively assigning points to the nearest center and updating the centers. It can be shown that this process will decrease the objective function, making it a greedy algorithm.</p>
</section>
</section>
<section id="potential-problems" class="level1">
<h1>Potential problems</h1>
<p>K-means has the potential problem of local minima. This can be illustrated in two dimensions by assigning points to the four corners of a square and using three of them as starting positions, which can lead to poor initializations.</p>
<p>The issue of non-uniqueness for optima should not be problematic in our case, as we are dealing with continuous distributions (or at least it seems unlikely).</p>
<p>K-means++ is also sensitive to outliers. This problem is present in the structure of the likelihood for mixture models as well. If there is a small cluster of outliers, the fitted t-distribution can become very sharp, giving a high likelihood to those points. This should be mitigated by ensuring that the probability of drawing from this distribution is very small. However, there is no guarantee that this is always the case. Essentially, this means that outliers may not be treated as such but rather as draws from a separate distribution.</p>
<p>Despite these issues, the method based on k-means++ still seems like the best option. Otherwise, one can set the starting parameters manually.</p>
<p>For estimating the individual t-distributions, we use the condition <span class="math inline">\(\nu &gt;2\)</span>. Given this, we can use the following results:</p>
<p><span class="math inline">\(\mathbb{E}[X]=\mu\)</span> and <span class="math inline">\(Var(X)=\sigma^2\frac{\nu}{\nu-2}\rightarrow 2\frac{ Var(X)}{Var(X)-\sigma^2}=\nu\)</span> ore <span class="math inline">\(Var(X)=\sigma^2\frac{\nu}{\nu-2}\rightarrow \sqrt{Var(X)\frac{\nu-2}{\nu}}=\sigma\)</span></p>
<p>Since this is only for initialization, if the parameters for the t-distributions are overshot, the EM algorithm should correct for it. The advantage is that with a good estimate of the parameters <span class="math inline">\(\mu\)</span> and <span class="math inline">\(\nu\)</span>, and <span class="math inline">\(\sigma\)</span>, standard optimization can be used to estimate the last parameter based on the log likelihood.</p>
<p>This method often fails, so it may be better to use grid search or manual tuning.</p>
<section id="gridsearch-initialization" class="level2">
<h2 class="anchored" data-anchor-id="gridsearch-initialization">GridSearch Initialization</h2>
<p>In most cases, the method of using K-means partitions to estimate <span class="math inline">\(\mu\)</span> and using the proportions to estimate <span class="math inline">\(\pi\)</span> seems reasonable. So, I have implemented a version where GridSearch is used for the parameters <span class="math inline">\(\sigma\)</span> and <span class="math inline">\(\nu\)</span>, which is what caused problems before. By doing this, one gets the advantage of the simplicity and relative speed of using K-means while obtaining usable starting parameters for <span class="math inline">\(\sigma\)</span> and <span class="math inline">\(\nu\)</span>.</p>
</section>
</section>
<section id="measurs" class="level1">
<h1>Measurs</h1>
<p>If one wants to compare models, the Akaike Information Criterion (AIC) and the Bayesian Information Criterion (BIC) are available.</p>
</section>
<section id="code" class="level1">
<h1>Code</h1>
<p>Librays used.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load required libraries</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(this.path) <span class="co"># find where you are</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Note current script location</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>current_script_directory <span class="ot">&lt;-</span> <span class="fu">this.dir</span>()</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="co"># library's to Rcpp</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"Rcpp"</span>)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"RcppArmadillo"</span>)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"RcppGSL"</span>)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="fu">sourceCpp</span>(<span class="st">"compstat.cpp"</span>)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ClusterR)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="co">#KMeans_rcpp #kmeans++ works well and is in Rcpp</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="co"># for fiting scaled and shifted t-distribution</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(fitdistrplus)</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MASS)</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="co"># for paraleel gridseach in the intilasation</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(doParallel)</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(foreach)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>My own implented code i R.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># build function in R</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"metRology"</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"extraDistr"</span>)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co">#function for generating a vector of draws from a mixture T distribuations</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>Draw_mixture_componet <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">Pi=</span><span class="fu">c</span>(<span class="fl">0.2</span>, <span class="fl">0.5</span>, <span class="fl">0.3</span>),</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">Mu=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">25</span>,<span class="dv">50</span>),</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">Sigma=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">1</span>),</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">Nu=</span><span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">4</span>),</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">N_samples=</span><span class="dv">1000</span>){</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>  <span class="co">#sample mixture componets</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>  mixture_componoets_sample <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="at">x =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(Pi), <span class="at">size =</span> N_samples, <span class="at">replace =</span> <span class="cn">TRUE</span>, <span class="at">prob =</span> Pi)</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>  draws<span class="ot">=</span><span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">0</span>,N_samples))</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N_samples){</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>    d_i<span class="ot">=</span><span class="fu">sample</span>(<span class="at">x =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(Pi), <span class="at">size =</span> <span class="dv">1</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>, <span class="at">prob =</span> Pi) <span class="co">#draw_index = d_i</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>    draws[i]<span class="ot">=</span><span class="fu">rt.scaled</span>(<span class="at">n =</span> <span class="dv">1</span>, <span class="at">df =</span> Nu[d_i], <span class="at">mean =</span> Mu[d_i], <span class="at">sd =</span> Sigma[d_i])</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(draws)</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a><span class="co"># itnernall function of initialation</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>initialize_if_na <span class="ot">&lt;-</span> <span class="cf">function</span>(var,<span class="co"># variabels</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>                             K<span class="co"># numer of partions</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>                             ) {</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">any</span>(<span class="fu">is.na</span>(var))) {</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">rep</span>(<span class="cn">NA</span>, K))</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(var)</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a><span class="co"># estimation of PI by taking proportion of partions</span></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>Estiame_Pi_from_partions<span class="ot">=</span> <span class="cf">function</span>(Partions_vec,K){</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>  Pi<span class="ot">=</span><span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">0</span>,K))</span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>K){</span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>    Mid_vec<span class="ot">=</span>Partions_vec<span class="sc">==</span>i</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>    Pi[i]<span class="ot">=</span><span class="fu">sum</span>(Mid_vec)<span class="sc">/</span><span class="fu">length</span>(Partions_vec)</span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(Pi)</span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a><span class="co"># This is not the best parameter, but for now its better than guissing.</span></span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a><span class="co"># it seam to work well for well seperated distribuations</span></span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>Intiall_parameter_optimasation<span class="ot">&lt;-</span><span class="cf">function</span>(X<span class="co">#Data from parametasion</span></span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>    ){</span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>  Mu<span class="ot">&lt;-</span><span class="fu">mean</span>(X)</span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>  variance<span class="ot">=</span><span class="fu">var</span>(X)</span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a>  fn1<span class="ot">&lt;-</span><span class="cf">function</span>(s){<span class="fu">sum</span>(<span class="sc">-</span>(<span class="fu">dlst</span>(X, <span class="at">df=</span><span class="fu">abs</span>(s), <span class="at">mu =</span> Mu, <span class="at">sigma =</span> <span class="fu">sqrt</span>(variance<span class="sc">*</span>(<span class="fu">abs</span>(s)<span class="sc">-</span><span class="dv">2</span>)<span class="sc">/</span><span class="fu">abs</span>(s)) , <span class="at">log =</span> <span class="cn">TRUE</span>)))}</span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">optim</span>(<span class="at">par =</span> <span class="dv">5</span>, <span class="at">fn =</span> fn1, <span class="at">method =</span> <span class="st">"L-BFGS-B"</span>,</span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a>  <span class="at">lower =</span> <span class="fu">c</span>(<span class="dv">2</span><span class="fl">+0.05</span>))</span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a>  Nu_val<span class="ot">=</span>(<span class="fu">abs</span>(result<span class="sc">$</span>par))</span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a>  Sigma_val<span class="ot">=</span><span class="fu">sqrt</span>(variance<span class="sc">*</span>(Nu_val<span class="dv">-2</span>)<span class="sc">/</span>Nu_val) </span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">c</span>(Mu,Sigma_val,Nu_val))</span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-57"><a href="#cb2-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-58"><a href="#cb2-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-59"><a href="#cb2-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-60"><a href="#cb2-60" aria-hidden="true" tabindex="-1"></a>Intiall_parameter<span class="ot">&lt;-</span><span class="cf">function</span>(X,<span class="co">#Data in vector form</span></span>
<span id="cb2-61"><a href="#cb2-61" aria-hidden="true" tabindex="-1"></a>                        <span class="at">Pi=</span><span class="cn">NA</span>,<span class="co">#Problillaty vector</span></span>
<span id="cb2-62"><a href="#cb2-62" aria-hidden="true" tabindex="-1"></a>                        <span class="at">Mu=</span><span class="cn">NA</span>,<span class="co"># mean vector</span></span>
<span id="cb2-63"><a href="#cb2-63" aria-hidden="true" tabindex="-1"></a>                        <span class="at">Sigma=</span><span class="cn">NA</span>,<span class="co">#Sigma vector </span></span>
<span id="cb2-64"><a href="#cb2-64" aria-hidden="true" tabindex="-1"></a>                        <span class="at">Nu =</span><span class="cn">NA</span>, <span class="co"># NU vector</span></span>
<span id="cb2-65"><a href="#cb2-65" aria-hidden="true" tabindex="-1"></a>                        K <span class="co"># Number of distribuations</span></span>
<span id="cb2-66"><a href="#cb2-66" aria-hidden="true" tabindex="-1"></a>                  ){</span>
<span id="cb2-67"><a href="#cb2-67" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">any</span>(<span class="fu">c</span>(<span class="fu">is.na</span>(Pi),<span class="fu">is.na</span>(Mu),<span class="fu">is.na</span>(Sigma),<span class="fu">is.na</span>(Nu)))){</span>
<span id="cb2-68"><a href="#cb2-68" aria-hidden="true" tabindex="-1"></a>    <span class="co"># get partions</span></span>
<span id="cb2-69"><a href="#cb2-69" aria-hidden="true" tabindex="-1"></a>    KMeans_objet<span class="ot">=</span><span class="fu">KMeans_rcpp</span>(<span class="fu">as.matrix</span>(X), <span class="at">clusters =</span> K, <span class="at">num_init =</span> <span class="dv">30</span>, <span class="at">initializer =</span> <span class="st">'kmeans++'</span>)</span>
<span id="cb2-70"><a href="#cb2-70" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-71"><a href="#cb2-71" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">any</span>(<span class="fu">is.na</span>(Pi))){</span>
<span id="cb2-72"><a href="#cb2-72" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Estimate Pi</span></span>
<span id="cb2-73"><a href="#cb2-73" aria-hidden="true" tabindex="-1"></a>    Pi<span class="ot">=</span><span class="fu">Estiame_Pi_from_partions</span>(KMeans_objet<span class="sc">$</span>clusters,K)</span>
<span id="cb2-74"><a href="#cb2-74" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-75"><a href="#cb2-75" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-76"><a href="#cb2-76" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">any</span>(<span class="fu">c</span>(<span class="fu">is.na</span>(Mu),<span class="fu">is.na</span>(Sigma),<span class="fu">is.na</span>(Nu)))){</span>
<span id="cb2-77"><a href="#cb2-77" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Make sure their is vector </span></span>
<span id="cb2-78"><a href="#cb2-78" aria-hidden="true" tabindex="-1"></a>    Mu<span class="ot">=</span><span class="fu">initialize_if_na</span>(Mu,K)</span>
<span id="cb2-79"><a href="#cb2-79" aria-hidden="true" tabindex="-1"></a>    Sigma<span class="ot">=</span><span class="fu">initialize_if_na</span>(Sigma,K)</span>
<span id="cb2-80"><a href="#cb2-80" aria-hidden="true" tabindex="-1"></a>    Nu<span class="ot">=</span><span class="fu">initialize_if_na</span>(Nu,K)</span>
<span id="cb2-81"><a href="#cb2-81" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>K){</span>
<span id="cb2-82"><a href="#cb2-82" aria-hidden="true" tabindex="-1"></a>      partin_data<span class="ot">=</span>X[KMeans_objet<span class="sc">$</span>clusters<span class="sc">==</span>i]</span>
<span id="cb2-83"><a href="#cb2-83" aria-hidden="true" tabindex="-1"></a>      partin_parameter<span class="ot">=</span><span class="fu">Intiall_parameter_optimasation</span>(partin_data)</span>
<span id="cb2-84"><a href="#cb2-84" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">is.na</span>(Mu[i])){</span>
<span id="cb2-85"><a href="#cb2-85" aria-hidden="true" tabindex="-1"></a>        Mu[i]<span class="ot">=</span>partin_parameter[<span class="dv">1</span>]</span>
<span id="cb2-86"><a href="#cb2-86" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb2-87"><a href="#cb2-87" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">is.na</span>(Sigma[i])){</span>
<span id="cb2-88"><a href="#cb2-88" aria-hidden="true" tabindex="-1"></a>        Sigma[i]<span class="ot">=</span>partin_parameter[<span class="dv">2</span>]</span>
<span id="cb2-89"><a href="#cb2-89" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb2-90"><a href="#cb2-90" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">is.na</span>(Nu[i])){</span>
<span id="cb2-91"><a href="#cb2-91" aria-hidden="true" tabindex="-1"></a>        Nu[i]<span class="ot">=</span>partin_parameter[<span class="dv">3</span>]</span>
<span id="cb2-92"><a href="#cb2-92" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb2-93"><a href="#cb2-93" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-94"><a href="#cb2-94" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-95"><a href="#cb2-95" aria-hidden="true" tabindex="-1"></a>  ret_obj<span class="ot">=</span><span class="fu">list</span>(<span class="at">Mu =</span> Mu,</span>
<span id="cb2-96"><a href="#cb2-96" aria-hidden="true" tabindex="-1"></a>               <span class="at">Sigma =</span> Sigma,</span>
<span id="cb2-97"><a href="#cb2-97" aria-hidden="true" tabindex="-1"></a>               <span class="at">Nu=</span>Nu,</span>
<span id="cb2-98"><a href="#cb2-98" aria-hidden="true" tabindex="-1"></a>               <span class="at">Pi=</span>Pi)</span>
<span id="cb2-99"><a href="#cb2-99" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(ret_obj)</span>
<span id="cb2-100"><a href="#cb2-100" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-101"><a href="#cb2-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-102"><a href="#cb2-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-103"><a href="#cb2-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-104"><a href="#cb2-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-105"><a href="#cb2-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-106"><a href="#cb2-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-107"><a href="#cb2-107" aria-hidden="true" tabindex="-1"></a><span class="co"># use kmeans to Pi estimate pi and mu</span></span>
<span id="cb2-108"><a href="#cb2-108" aria-hidden="true" tabindex="-1"></a>Intiall_parameter_grid<span class="ot">=</span><span class="cf">function</span>(X,Pi,Mu,Sigma_grid,Nu_grid,K){</span>
<span id="cb2-109"><a href="#cb2-109" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">any</span>(<span class="fu">c</span>(<span class="fu">is.na</span>(Pi),<span class="fu">is.na</span>(Mu)))){</span>
<span id="cb2-110"><a href="#cb2-110" aria-hidden="true" tabindex="-1"></a>    <span class="co"># get partions</span></span>
<span id="cb2-111"><a href="#cb2-111" aria-hidden="true" tabindex="-1"></a>    KMeans_objet<span class="ot">=</span><span class="fu">KMeans_rcpp</span>(<span class="fu">as.matrix</span>(X), <span class="at">clusters =</span> K, <span class="at">num_init =</span> <span class="dv">30</span>, <span class="at">initializer =</span> <span class="st">'kmeans++'</span>)</span>
<span id="cb2-112"><a href="#cb2-112" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-113"><a href="#cb2-113" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">any</span>(<span class="fu">is.na</span>(Pi))){</span>
<span id="cb2-114"><a href="#cb2-114" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Estimate Pi</span></span>
<span id="cb2-115"><a href="#cb2-115" aria-hidden="true" tabindex="-1"></a>    Pi<span class="ot">=</span><span class="fu">Estiame_Pi_from_partions</span>(KMeans_objet<span class="sc">$</span>clusters,K)</span>
<span id="cb2-116"><a href="#cb2-116" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-117"><a href="#cb2-117" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-118"><a href="#cb2-118" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">any</span>(<span class="fu">is.na</span>(Mu))){</span>
<span id="cb2-119"><a href="#cb2-119" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Make sure their is vector </span></span>
<span id="cb2-120"><a href="#cb2-120" aria-hidden="true" tabindex="-1"></a>    Mu<span class="ot">=</span><span class="fu">initialize_if_na</span>(Mu,K)</span>
<span id="cb2-121"><a href="#cb2-121" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>K){</span>
<span id="cb2-122"><a href="#cb2-122" aria-hidden="true" tabindex="-1"></a>      partin_data<span class="ot">=</span>X[KMeans_objet<span class="sc">$</span>clusters<span class="sc">==</span>i]</span>
<span id="cb2-123"><a href="#cb2-123" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb2-124"><a href="#cb2-124" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">is.na</span>(Mu[i])){</span>
<span id="cb2-125"><a href="#cb2-125" aria-hidden="true" tabindex="-1"></a>        Mu[i]<span class="ot">=</span><span class="fu">mean</span>(partin_data)</span>
<span id="cb2-126"><a href="#cb2-126" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb2-127"><a href="#cb2-127" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-128"><a href="#cb2-128" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-129"><a href="#cb2-129" aria-hidden="true" tabindex="-1"></a>  <span class="co">#preform gridseach but only over paramters Sigma and nu</span></span>
<span id="cb2-130"><a href="#cb2-130" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-131"><a href="#cb2-131" aria-hidden="true" tabindex="-1"></a>  <span class="co">#Finding combinations</span></span>
<span id="cb2-132"><a href="#cb2-132" aria-hidden="true" tabindex="-1"></a>  <span class="co">#Sigma_grid=as.numeric(seq(2,5))</span></span>
<span id="cb2-133"><a href="#cb2-133" aria-hidden="true" tabindex="-1"></a>  <span class="co">#make list with comnations </span></span>
<span id="cb2-134"><a href="#cb2-134" aria-hidden="true" tabindex="-1"></a>  Sigma_grid_combinations <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="fu">rep</span>(<span class="fu">list</span>(Sigma_grid), K))</span>
<span id="cb2-135"><a href="#cb2-135" aria-hidden="true" tabindex="-1"></a>  <span class="co">#makes List of list whith every combantion in the seq Sigma_grid</span></span>
<span id="cb2-136"><a href="#cb2-136" aria-hidden="true" tabindex="-1"></a>  list_of_combinations_Sigma <span class="ot">&lt;-</span> <span class="fu">split</span>(<span class="fu">as.matrix</span>(Sigma_grid_combinations), <span class="fu">seq</span>(<span class="fu">nrow</span>(Sigma_grid_combinations)))</span>
<span id="cb2-137"><a href="#cb2-137" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-138"><a href="#cb2-138" aria-hidden="true" tabindex="-1"></a>  <span class="co">#Nu_grid=as.numeric(seq(2,10))</span></span>
<span id="cb2-139"><a href="#cb2-139" aria-hidden="true" tabindex="-1"></a>  Nu_grid_combinations<span class="ot">&lt;-</span><span class="fu">expand.grid</span>(<span class="fu">rep</span>(<span class="fu">list</span>(Nu_grid), K))</span>
<span id="cb2-140"><a href="#cb2-140" aria-hidden="true" tabindex="-1"></a>  list_of_combinations_Nu <span class="ot">&lt;-</span> <span class="fu">split</span>(<span class="fu">as.matrix</span>(Nu_grid_combinations), <span class="fu">seq</span>(<span class="fu">nrow</span>(Nu_grid_combinations)))</span>
<span id="cb2-141"><a href="#cb2-141" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-142"><a href="#cb2-142" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-143"><a href="#cb2-143" aria-hidden="true" tabindex="-1"></a>  grid_for_seach<span class="ot">=</span><span class="fu">expand.grid</span>(list_of_combinations_Sigma,list_of_combinations_Nu)</span>
<span id="cb2-144"><a href="#cb2-144" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-145"><a href="#cb2-145" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-146"><a href="#cb2-146" aria-hidden="true" tabindex="-1"></a>  <span class="co"># This can be paralised but, it mean define all the functions from Rcpp in R so they can be importet into the clusters</span></span>
<span id="cb2-147"><a href="#cb2-147" aria-hidden="true" tabindex="-1"></a>  <span class="co">#souch rcpp can export function to paralles so redefine functions</span></span>
<span id="cb2-148"><a href="#cb2-148" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-149"><a href="#cb2-149" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # Number of cores to use</span></span>
<span id="cb2-150"><a href="#cb2-150" aria-hidden="true" tabindex="-1"></a>  <span class="co"># num_cores &lt;- detectCores() - 1 # supose to be nice to let one stand for other stuff</span></span>
<span id="cb2-151"><a href="#cb2-151" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # Create a cluster</span></span>
<span id="cb2-152"><a href="#cb2-152" aria-hidden="true" tabindex="-1"></a>  <span class="co"># cl &lt;- makeCluster(num_cores)</span></span>
<span id="cb2-153"><a href="#cb2-153" aria-hidden="true" tabindex="-1"></a>  <span class="co"># registerDoParallel(cl)</span></span>
<span id="cb2-154"><a href="#cb2-154" aria-hidden="true" tabindex="-1"></a>  <span class="co"># clusterExport(cl, c("loglikelyhood_t_mix", "X", "Pi", "Mu", "grid_for_seach"))</span></span>
<span id="cb2-155"><a href="#cb2-155" aria-hidden="true" tabindex="-1"></a>  <span class="co"># </span></span>
<span id="cb2-156"><a href="#cb2-156" aria-hidden="true" tabindex="-1"></a>  <span class="co"># results &lt;- foreach(i = 1:nrow(grid_for_seach), .combine = rbind) %dopar% {</span></span>
<span id="cb2-157"><a href="#cb2-157" aria-hidden="true" tabindex="-1"></a>  <span class="co"># row &lt;- grid_for_seach[i, ]</span></span>
<span id="cb2-158"><a href="#cb2-158" aria-hidden="true" tabindex="-1"></a>  <span class="co"># var1 &lt;- as.vector(unlist((row[1]))) </span></span>
<span id="cb2-159"><a href="#cb2-159" aria-hidden="true" tabindex="-1"></a>  <span class="co"># var2 &lt;-  as.vector(unlist((row[2])))#</span></span>
<span id="cb2-160"><a href="#cb2-160" aria-hidden="true" tabindex="-1"></a>  <span class="co"># </span></span>
<span id="cb2-161"><a href="#cb2-161" aria-hidden="true" tabindex="-1"></a>  <span class="co"># log_likelihood_val &lt;- den_test(X, Pi, Mu, c(5,5,5), c(4,4,4)) # function can be importet to clusters so the method wont work</span></span>
<span id="cb2-162"><a href="#cb2-162" aria-hidden="true" tabindex="-1"></a>  <span class="co"># c(var1 = var1, var2 = var2, log_likelihood_val = log_likelihood_val) </span></span>
<span id="cb2-163"><a href="#cb2-163" aria-hidden="true" tabindex="-1"></a>  <span class="co"># }</span></span>
<span id="cb2-164"><a href="#cb2-164" aria-hidden="true" tabindex="-1"></a>  <span class="co"># stopCluster(cl)</span></span>
<span id="cb2-165"><a href="#cb2-165" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-166"><a href="#cb2-166" aria-hidden="true" tabindex="-1"></a>  compute_log_likelihood <span class="ot">&lt;-</span> <span class="cf">function</span>(row) {</span>
<span id="cb2-167"><a href="#cb2-167" aria-hidden="true" tabindex="-1"></a>  var1 <span class="ot">&lt;-</span> <span class="fu">as.vector</span>(<span class="fu">unlist</span>(row[<span class="dv">1</span>]))</span>
<span id="cb2-168"><a href="#cb2-168" aria-hidden="true" tabindex="-1"></a>  var2 <span class="ot">&lt;-</span> <span class="fu">as.vector</span>(<span class="fu">unlist</span>(row[<span class="dv">2</span>]))</span>
<span id="cb2-169"><a href="#cb2-169" aria-hidden="true" tabindex="-1"></a>  <span class="fu">loglikelyhood_t_mix</span>(X, Pi, Mu, var1, var2)</span>
<span id="cb2-170"><a href="#cb2-170" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-171"><a href="#cb2-171" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-172"><a href="#cb2-172" aria-hidden="true" tabindex="-1"></a>  log_likelihood_values <span class="ot">&lt;-</span> <span class="fu">sapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(grid_for_seach), <span class="cf">function</span>(i) {</span>
<span id="cb2-173"><a href="#cb2-173" aria-hidden="true" tabindex="-1"></a>    <span class="fu">compute_log_likelihood</span>(grid_for_seach[i, ])</span>
<span id="cb2-174"><a href="#cb2-174" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb2-175"><a href="#cb2-175" aria-hidden="true" tabindex="-1"></a>  max_log_likelihood <span class="ot">&lt;-</span> <span class="fu">max</span>(log_likelihood_values)</span>
<span id="cb2-176"><a href="#cb2-176" aria-hidden="true" tabindex="-1"></a>  max_index <span class="ot">&lt;-</span> <span class="fu">which.max</span>(log_likelihood_values)</span>
<span id="cb2-177"><a href="#cb2-177" aria-hidden="true" tabindex="-1"></a>  Sigma<span class="ot">=</span><span class="fu">as.vector</span>(<span class="fu">unlist</span>(grid_for_seach[max_index,]<span class="sc">$</span>Var1))</span>
<span id="cb2-178"><a href="#cb2-178" aria-hidden="true" tabindex="-1"></a>  Nu<span class="ot">=</span><span class="fu">as.vector</span>(<span class="fu">unlist</span>(grid_for_seach[max_index,]<span class="sc">$</span>Var2))</span>
<span id="cb2-179"><a href="#cb2-179" aria-hidden="true" tabindex="-1"></a>  ret_obj<span class="ot">=</span><span class="fu">list</span>(<span class="at">Mu =</span> Mu,</span>
<span id="cb2-180"><a href="#cb2-180" aria-hidden="true" tabindex="-1"></a>               <span class="at">Sigma =</span> Sigma,</span>
<span id="cb2-181"><a href="#cb2-181" aria-hidden="true" tabindex="-1"></a>               <span class="at">Nu=</span>Nu,</span>
<span id="cb2-182"><a href="#cb2-182" aria-hidden="true" tabindex="-1"></a>               <span class="at">Pi=</span>Pi,</span>
<span id="cb2-183"><a href="#cb2-183" aria-hidden="true" tabindex="-1"></a>               <span class="at">likelyhood=</span>max_log_likelihood,</span>
<span id="cb2-184"><a href="#cb2-184" aria-hidden="true" tabindex="-1"></a>               <span class="at">Numer_of_combination=</span><span class="fu">nrow</span>(grid_for_seach))</span>
<span id="cb2-185"><a href="#cb2-185" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(ret_obj)</span>
<span id="cb2-186"><a href="#cb2-186" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-187"><a href="#cb2-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-188"><a href="#cb2-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-189"><a href="#cb2-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-190"><a href="#cb2-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-191"><a href="#cb2-191" aria-hidden="true" tabindex="-1"></a><span class="co">#Kmeans is used to run make intiall partions, when Scaled shifted t distribuation is fitted on each partions.</span></span>
<span id="cb2-192"><a href="#cb2-192" aria-hidden="true" tabindex="-1"></a><span class="co"># This method works well when the distribuations is well seperated, but not if mixture distributuin is to close.</span></span>
<span id="cb2-193"><a href="#cb2-193" aria-hidden="true" tabindex="-1"></a><span class="co">#basically what happen if the partions is to close what happens is that partions do not look like t distribution, and can somtime even look like uniform distribution (basically far of), this make the estimation of the ustabel and sometimes lead to error, the solution is to come with some manuall inputs </span></span>
<span id="cb2-194"><a href="#cb2-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-195"><a href="#cb2-195" aria-hidden="true" tabindex="-1"></a>EM_Mix_T_Dist<span class="ot">&lt;-</span><span class="cf">function</span>(X,<span class="co">#Data in vector form</span></span>
<span id="cb2-196"><a href="#cb2-196" aria-hidden="true" tabindex="-1"></a>                        <span class="at">Pi=</span><span class="cn">NA</span>,<span class="co">#Problillaty vector</span></span>
<span id="cb2-197"><a href="#cb2-197" aria-hidden="true" tabindex="-1"></a>                        <span class="at">Mu=</span><span class="cn">NA</span>,<span class="co"># mean vector</span></span>
<span id="cb2-198"><a href="#cb2-198" aria-hidden="true" tabindex="-1"></a>                        <span class="at">Sigma=</span><span class="cn">NA</span>,<span class="co">#Sigma vector </span></span>
<span id="cb2-199"><a href="#cb2-199" aria-hidden="true" tabindex="-1"></a>                        <span class="at">Nu =</span><span class="cn">NA</span>, <span class="co"># NU vector</span></span>
<span id="cb2-200"><a href="#cb2-200" aria-hidden="true" tabindex="-1"></a>                        K, <span class="co"># Number of distribuations</span></span>
<span id="cb2-201"><a href="#cb2-201" aria-hidden="true" tabindex="-1"></a>                        <span class="at">Clipping_vector=</span><span class="fu">c</span>(<span class="dv">10</span>,<span class="dv">5</span>,<span class="dv">2</span>),<span class="co"># Max value for clipping  for parameters (Mu,Sigma,Ni)</span></span>
<span id="cb2-202"><a href="#cb2-202" aria-hidden="true" tabindex="-1"></a>                        <span class="at">Max_iter=</span><span class="dv">100</span>,<span class="co"># maxium number of interations for the EM algorithm</span></span>
<span id="cb2-203"><a href="#cb2-203" aria-hidden="true" tabindex="-1"></a>                        <span class="at">alpha=</span><span class="fl">0.02</span>,<span class="co"># scaling for gradient decent</span></span>
<span id="cb2-204"><a href="#cb2-204" aria-hidden="true" tabindex="-1"></a>                        <span class="at">max_iter_gradient=</span><span class="dv">3</span>,<span class="co"># maxium number of times in graident for each iteratin</span></span>
<span id="cb2-205"><a href="#cb2-205" aria-hidden="true" tabindex="-1"></a>                        <span class="at">norm_gradient =</span> <span class="fl">0.1</span>, <span class="co"># stop criteria for gradient decent</span></span>
<span id="cb2-206"><a href="#cb2-206" aria-hidden="true" tabindex="-1"></a>                        <span class="at">Start_method_optim=</span>T){</span>
<span id="cb2-207"><a href="#cb2-207" aria-hidden="true" tabindex="-1"></a>  <span class="co">#Checking for intiations process</span></span>
<span id="cb2-208"><a href="#cb2-208" aria-hidden="true" tabindex="-1"></a>  <span class="co">#if no argument is given for Pi , Mu , Sigma and NU is given then a gues is made</span></span>
<span id="cb2-209"><a href="#cb2-209" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(Start_method_optim<span class="sc">==</span>T){</span>
<span id="cb2-210"><a href="#cb2-210" aria-hidden="true" tabindex="-1"></a>    start_para<span class="ot">=</span><span class="fu">Intiall_parameter</span>(X,Pi,Mu,Sigma,Nu,K)</span>
<span id="cb2-211"><a href="#cb2-211" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-212"><a href="#cb2-212" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span>{</span>
<span id="cb2-213"><a href="#cb2-213" aria-hidden="true" tabindex="-1"></a>    start_para<span class="ot">=</span><span class="fu">Intiall_parameter_grid</span>(X,Pi,Mu,<span class="at">Sigma_grid=</span><span class="fu">as.numeric</span>(<span class="fu">seq</span>(<span class="dv">1</span>,<span class="dv">15</span>,<span class="dv">2</span>)),<span class="fu">as.numeric</span>(<span class="fu">seq</span>(<span class="dv">2</span>,<span class="dv">10</span>,<span class="dv">2</span>)),K)</span>
<span id="cb2-214"><a href="#cb2-214" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-215"><a href="#cb2-215" aria-hidden="true" tabindex="-1"></a>  Pi<span class="ot">=</span>start_para<span class="sc">$</span>Pi</span>
<span id="cb2-216"><a href="#cb2-216" aria-hidden="true" tabindex="-1"></a>  Mu<span class="ot">=</span>start_para<span class="sc">$</span>Mu</span>
<span id="cb2-217"><a href="#cb2-217" aria-hidden="true" tabindex="-1"></a>  Sigma<span class="ot">=</span>start_para<span class="sc">$</span>Sigma</span>
<span id="cb2-218"><a href="#cb2-218" aria-hidden="true" tabindex="-1"></a>  Nu<span class="ot">=</span>start_para<span class="sc">$</span>Nu</span>
<span id="cb2-219"><a href="#cb2-219" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-220"><a href="#cb2-220" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">any</span>(<span class="fu">c</span>(<span class="fu">is.na</span>(Pi),<span class="fu">is.na</span>(Mu),<span class="fu">is.na</span>(Sigma),<span class="fu">is.na</span>(Nu)))){</span>
<span id="cb2-221"><a href="#cb2-221" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(<span class="st">"The intilasaions failed"</span>)</span>
<span id="cb2-222"><a href="#cb2-222" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">NA</span>)</span>
<span id="cb2-223"><a href="#cb2-223" aria-hidden="true" tabindex="-1"></a>  } </span>
<span id="cb2-224"><a href="#cb2-224" aria-hidden="true" tabindex="-1"></a>  <span class="co">#Run EM</span></span>
<span id="cb2-225"><a href="#cb2-225" aria-hidden="true" tabindex="-1"></a>  EM_partion<span class="ot">=</span><span class="fu">EM_t_distribution</span>(X,Pi,Mu,Sigma,Nu,<span class="at">Clipping_vector =</span> Clipping_vector,<span class="at">Max_iter=</span>Max_iter,<span class="at">alpha=</span>alpha,<span class="at">max_iter_gradient=</span>max_iter_gradient,<span class="at">norm_gradient =</span> norm_gradient)</span>
<span id="cb2-226"><a href="#cb2-226" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-227"><a href="#cb2-227" aria-hidden="true" tabindex="-1"></a>  <span class="co">#Make return object</span></span>
<span id="cb2-228"><a href="#cb2-228" aria-hidden="true" tabindex="-1"></a>  likelyhood<span class="ot">=</span><span class="fu">likelyhood_t_mix</span>(X,EM_partion[,<span class="dv">4</span>],EM_partion[,<span class="dv">1</span>],EM_partion[,<span class="dv">2</span>],EM_partion[,<span class="dv">3</span>])</span>
<span id="cb2-229"><a href="#cb2-229" aria-hidden="true" tabindex="-1"></a>  loglikelyhood<span class="ot">=</span><span class="fu">loglikelyhood_t_mix</span>(X,EM_partion[,<span class="dv">4</span>],EM_partion[,<span class="dv">1</span>],EM_partion[,<span class="dv">2</span>],EM_partion[,<span class="dv">3</span>])</span>
<span id="cb2-230"><a href="#cb2-230" aria-hidden="true" tabindex="-1"></a>  AIC<span class="ot">=</span><span class="dv">2</span><span class="sc">*</span>K<span class="dv">-2</span><span class="sc">*</span>loglikelyhood</span>
<span id="cb2-231"><a href="#cb2-231" aria-hidden="true" tabindex="-1"></a>  BIC<span class="ot">=</span>K<span class="sc">*</span><span class="fu">log</span>(<span class="fu">length</span>(X))<span class="sc">-</span><span class="dv">2</span><span class="sc">*</span>loglikelyhood</span>
<span id="cb2-232"><a href="#cb2-232" aria-hidden="true" tabindex="-1"></a>  ret_obj<span class="ot">=</span><span class="fu">list</span>(<span class="at">Mu =</span> EM_partion[,<span class="dv">1</span>],</span>
<span id="cb2-233"><a href="#cb2-233" aria-hidden="true" tabindex="-1"></a>               <span class="at">Sigma =</span> EM_partion[,<span class="dv">2</span>],</span>
<span id="cb2-234"><a href="#cb2-234" aria-hidden="true" tabindex="-1"></a>               <span class="at">Nu=</span>EM_partion[,<span class="dv">3</span>],</span>
<span id="cb2-235"><a href="#cb2-235" aria-hidden="true" tabindex="-1"></a>               <span class="at">Pi=</span>EM_partion[,<span class="dv">4</span>],</span>
<span id="cb2-236"><a href="#cb2-236" aria-hidden="true" tabindex="-1"></a>               <span class="at">AIC=</span>AIC,</span>
<span id="cb2-237"><a href="#cb2-237" aria-hidden="true" tabindex="-1"></a>               <span class="at">BIC=</span>BIC,</span>
<span id="cb2-238"><a href="#cb2-238" aria-hidden="true" tabindex="-1"></a>               <span class="at">likelyhood=</span>likelyhood,</span>
<span id="cb2-239"><a href="#cb2-239" aria-hidden="true" tabindex="-1"></a>               <span class="at">loglikelyhood=</span>loglikelyhood,</span>
<span id="cb2-240"><a href="#cb2-240" aria-hidden="true" tabindex="-1"></a>               <span class="at">weights=</span><span class="fu">Weights_of_X</span>(X,EM_partion[,<span class="dv">4</span>],EM_partion[,<span class="dv">1</span>],EM_partion[,<span class="dv">2</span>],EM_partion[,<span class="dv">3</span>]))</span>
<span id="cb2-241"><a href="#cb2-241" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(ret_obj)</span>
<span id="cb2-242"><a href="#cb2-242" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Rcpp library</p>
<details>
<summary>
Click to expand/collapse the C++ code
</summary>
<div class="sourceCode" id="cb3"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;RcppArmadillo.h&gt;</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Rmath.h&gt;</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;cmath&gt;</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;RcppGSL.h&gt;</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;gsl/gsl_sf_psi.h&gt;</span><span class="pp"> </span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="co">// [[Rcpp::depends(RcppArmadillo)]]</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> <span class="kw">namespace</span> Rcpp<span class="op">;</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> <span class="kw">namespace</span> arma<span class="op">;</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> <span class="kw">namespace</span> std<span class="op">;</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> T_density<span class="op">(</span><span class="dt">double</span> x<span class="op">,</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>                 <span class="dt">double</span> Mu<span class="op">,</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>                 <span class="dt">double</span> Sigma<span class="op">,</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>                 <span class="dt">double</span> Nu<span class="op">){</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="op">(</span>Rf_gammafn<span class="op">((</span>Nu <span class="op">+</span> <span class="dv">1</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2.0</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span>Rf_gammafn<span class="op">(</span>Nu <span class="op">/</span> <span class="fl">2.0</span><span class="op">)*</span> sqrt<span class="op">(</span>M_PI <span class="op">*</span> Nu <span class="op">*</span> pow<span class="op">(</span>Sigma<span class="op">,</span> <span class="dv">2</span><span class="op">))))*</span>pow<span class="op">((</span><span class="dv">1</span><span class="op">+</span>pow<span class="op">((</span>x<span class="op">-</span>Mu<span class="op">),</span><span class="dv">2</span><span class="op">)/(</span>Nu<span class="op">*</span>pow<span class="op">(</span>Sigma<span class="op">,</span><span class="dv">2</span><span class="op">))),-(</span>Nu<span class="op">+</span><span class="dv">1</span><span class="op">)/</span><span class="fl">2.0</span><span class="op">);</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> Mix_T_density_x<span class="op">(</span><span class="dt">double</span> x<span class="op">,</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>                     vec Pi<span class="op">,</span> </span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>                     vec Mu<span class="op">,</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>                     vec Sigma<span class="op">,</span></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>                     vec Nu<span class="op">){</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>  vec <span class="dt">dens_of_x_for_each_t</span><span class="op">(</span>Pi<span class="op">.</span>n_elem<span class="op">);</span></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span><span class="dv">0</span><span class="op">;</span> i<span class="op">&lt;</span> Pi<span class="op">.</span>n_elem<span class="op">;++</span>i<span class="op">){</span></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>    <span class="dt">dens_of_x_for_each_t</span><span class="op">[</span>i<span class="op">]=</span>Pi<span class="op">[</span>i<span class="op">]*</span>T_density<span class="op">(</span>x<span class="op">,</span>Mu<span class="op">[</span>i<span class="op">],</span>Sigma<span class="op">[</span>i<span class="op">],</span>Nu<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>  <span class="dt">double</span> densdens_of_X<span class="op">=</span>sum<span class="op">(</span><span class="dt">dens_of_x_for_each_t</span><span class="op">);</span></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> densdens_of_X<span class="op">;</span></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>vec Mix_T_density<span class="op">(</span>vec X<span class="op">,</span></span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>                     vec Pi<span class="op">,</span> </span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>                     vec Mu<span class="op">,</span></span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a>                     vec Sigma<span class="op">,</span></span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>                     vec Nu<span class="op">){</span></span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>  vec Dens_for_each_x<span class="op">(</span>X<span class="op">.</span>n_elem<span class="op">);</span></span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> j<span class="op">=</span><span class="dv">0</span><span class="op">;</span> j<span class="op">&lt;</span>X<span class="op">.</span>n_elem<span class="op">;++</span>j<span class="op">){</span></span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a>    Dens_for_each_x<span class="op">[</span>j<span class="op">]</span> <span class="op">=</span> Mix_T_density_x<span class="op">(</span>X<span class="op">[</span>j<span class="op">],</span>Pi<span class="op">,</span>Mu<span class="op">,</span>Sigma<span class="op">,</span>Nu<span class="op">);</span></span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="op">(</span>Dens_for_each_x<span class="op">);</span></span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> likelyhood_t_mix<span class="op">(</span>vec X<span class="op">,</span></span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a>                  vec Pi<span class="op">,</span></span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a>                  vec mu<span class="op">,</span></span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a>                  vec Sigma<span class="op">,</span></span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a>                  vec Nu<span class="op">){</span></span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> prod<span class="op">(</span>Mix_T_density<span class="op">(</span>X<span class="op">,</span>Pi<span class="op">,</span>mu<span class="op">,</span>Sigma<span class="op">,</span>Nu<span class="op">));</span></span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb3-60"><a href="#cb3-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-61"><a href="#cb3-61" aria-hidden="true" tabindex="-1"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb3-62"><a href="#cb3-62" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> loglikelyhood_t_mix<span class="op">(</span>vec X<span class="op">,</span></span>
<span id="cb3-63"><a href="#cb3-63" aria-hidden="true" tabindex="-1"></a>                        vec Pi<span class="op">,</span></span>
<span id="cb3-64"><a href="#cb3-64" aria-hidden="true" tabindex="-1"></a>                        vec mu<span class="op">,</span></span>
<span id="cb3-65"><a href="#cb3-65" aria-hidden="true" tabindex="-1"></a>                        vec Sigma<span class="op">,</span></span>
<span id="cb3-66"><a href="#cb3-66" aria-hidden="true" tabindex="-1"></a>                        vec Nu<span class="op">){</span></span>
<span id="cb3-67"><a href="#cb3-67" aria-hidden="true" tabindex="-1"></a>  vec densities <span class="op">=</span> Mix_T_density<span class="op">(</span>X<span class="op">,</span> Pi<span class="op">,</span> mu<span class="op">,</span> Sigma<span class="op">,</span> Nu<span class="op">);</span></span>
<span id="cb3-68"><a href="#cb3-68" aria-hidden="true" tabindex="-1"></a>  <span class="dt">double</span> log_likelihood <span class="op">=</span> sum<span class="op">(</span>log<span class="op">(</span>densities<span class="op">));</span></span>
<span id="cb3-69"><a href="#cb3-69" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> log_likelihood<span class="op">;</span></span>
<span id="cb3-70"><a href="#cb3-70" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb3-71"><a href="#cb3-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-72"><a href="#cb3-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-73"><a href="#cb3-73" aria-hidden="true" tabindex="-1"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb3-74"><a href="#cb3-74" aria-hidden="true" tabindex="-1"></a>mat Weights_of_X<span class="op">(</span>vec X<span class="op">,</span></span>
<span id="cb3-75"><a href="#cb3-75" aria-hidden="true" tabindex="-1"></a>                 vec Pi<span class="op">,</span></span>
<span id="cb3-76"><a href="#cb3-76" aria-hidden="true" tabindex="-1"></a>                 vec mu<span class="op">,</span></span>
<span id="cb3-77"><a href="#cb3-77" aria-hidden="true" tabindex="-1"></a>                 vec Sigma<span class="op">,</span></span>
<span id="cb3-78"><a href="#cb3-78" aria-hidden="true" tabindex="-1"></a>                 vec Nu<span class="op">){</span></span>
<span id="cb3-79"><a href="#cb3-79" aria-hidden="true" tabindex="-1"></a>  <span class="co">//Row's is a given outcome Pi is the probiallty that it come from the j density</span></span>
<span id="cb3-80"><a href="#cb3-80" aria-hidden="true" tabindex="-1"></a>  mat Weigths<span class="op">(</span>X<span class="op">.</span>n_elem<span class="op">,</span>Pi<span class="op">.</span>n_elem<span class="op">);</span></span>
<span id="cb3-81"><a href="#cb3-81" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span><span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> X<span class="op">.</span>n_elem<span class="op">;</span> <span class="op">++</span>i<span class="op">){</span></span>
<span id="cb3-82"><a href="#cb3-82" aria-hidden="true" tabindex="-1"></a>    vec like_x_i<span class="op">(</span>Pi<span class="op">.</span>n_elem<span class="op">);</span> <span class="co">// make vector</span></span>
<span id="cb3-83"><a href="#cb3-83" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> j<span class="op">=</span><span class="dv">0</span><span class="op">;</span>j<span class="op">&lt;</span>Pi<span class="op">.</span>n_elem<span class="op">;++</span>j<span class="op">){</span></span>
<span id="cb3-84"><a href="#cb3-84" aria-hidden="true" tabindex="-1"></a>      like_x_i<span class="op">[</span>j<span class="op">]=</span>Pi<span class="op">[</span>j<span class="op">]*</span>T_density<span class="op">(</span>X<span class="op">[</span>i<span class="op">],</span>mu<span class="op">[</span>j<span class="op">],</span>Sigma<span class="op">[</span>j<span class="op">],</span>Nu<span class="op">[</span>j<span class="op">]);</span></span>
<span id="cb3-85"><a href="#cb3-85" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb3-86"><a href="#cb3-86" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> k<span class="op">=</span><span class="dv">0</span><span class="op">;</span>k<span class="op">&lt;</span>Pi<span class="op">.</span>n_elem<span class="op">;++</span>k<span class="op">){</span></span>
<span id="cb3-87"><a href="#cb3-87" aria-hidden="true" tabindex="-1"></a>    Weigths<span class="op">(</span>i<span class="op">,</span>k<span class="op">)=</span>like_x_i<span class="op">[</span>k<span class="op">]/</span>sum<span class="op">(</span>like_x_i<span class="op">);</span></span>
<span id="cb3-88"><a href="#cb3-88" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb3-89"><a href="#cb3-89" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb3-90"><a href="#cb3-90" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> Weigths<span class="op">;</span></span>
<span id="cb3-91"><a href="#cb3-91" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb3-92"><a href="#cb3-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-93"><a href="#cb3-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-94"><a href="#cb3-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-95"><a href="#cb3-95" aria-hidden="true" tabindex="-1"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb3-96"><a href="#cb3-96" aria-hidden="true" tabindex="-1"></a>vec get_Pi<span class="op">(</span>mat Weigths<span class="op">){</span></span>
<span id="cb3-97"><a href="#cb3-97" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>Weigths<span class="op">.</span>n_rows <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-98"><a href="#cb3-98" aria-hidden="true" tabindex="-1"></a>    Rcpp<span class="op">::</span>stop<span class="op">(</span><span class="st">"Input matrix has no rows"</span><span class="op">);</span></span>
<span id="cb3-99"><a href="#cb3-99" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb3-100"><a href="#cb3-100" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> sum<span class="op">(</span>Weigths<span class="op">,</span> <span class="dv">0</span><span class="op">).</span>t<span class="op">()</span> <span class="op">/</span> Weigths<span class="op">.</span>n_rows<span class="op">;</span></span>
<span id="cb3-101"><a href="#cb3-101" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb3-102"><a href="#cb3-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-103"><a href="#cb3-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-104"><a href="#cb3-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-105"><a href="#cb3-105" aria-hidden="true" tabindex="-1"></a><span class="co">// [[Rcpp::depends(RcppGSL)]]</span></span>
<span id="cb3-106"><a href="#cb3-106" aria-hidden="true" tabindex="-1"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb3-107"><a href="#cb3-107" aria-hidden="true" tabindex="-1"></a>mat gradient<span class="op">(</span>vec X<span class="op">,</span></span>
<span id="cb3-108"><a href="#cb3-108" aria-hidden="true" tabindex="-1"></a>             vec Pi<span class="op">,</span></span>
<span id="cb3-109"><a href="#cb3-109" aria-hidden="true" tabindex="-1"></a>             vec mu<span class="op">,</span></span>
<span id="cb3-110"><a href="#cb3-110" aria-hidden="true" tabindex="-1"></a>             vec Sigma<span class="op">,</span></span>
<span id="cb3-111"><a href="#cb3-111" aria-hidden="true" tabindex="-1"></a>             vec Nu<span class="op">,</span></span>
<span id="cb3-112"><a href="#cb3-112" aria-hidden="true" tabindex="-1"></a>             string normalise <span class="op">=</span><span class="st">"no_normaliztion"</span><span class="op">){</span></span>
<span id="cb3-113"><a href="#cb3-113" aria-hidden="true" tabindex="-1"></a>  <span class="co">// col mu ,Sigma, Nu</span></span>
<span id="cb3-114"><a href="#cb3-114" aria-hidden="true" tabindex="-1"></a>  mat Gradiets<span class="op">(</span>Pi<span class="op">.</span>n_elem<span class="op">,</span><span class="dv">3</span><span class="op">);</span></span>
<span id="cb3-115"><a href="#cb3-115" aria-hidden="true" tabindex="-1"></a>  <span class="co">// find weights</span></span>
<span id="cb3-116"><a href="#cb3-116" aria-hidden="true" tabindex="-1"></a>  mat w_x <span class="op">=</span> Weights_of_X<span class="op">(</span>X<span class="op">,</span>Pi<span class="op">,</span>mu<span class="op">,</span>Sigma<span class="op">,</span>Nu<span class="op">);</span></span>
<span id="cb3-117"><a href="#cb3-117" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-118"><a href="#cb3-118" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-119"><a href="#cb3-119" aria-hidden="true" tabindex="-1"></a>  <span class="co">// mu</span></span>
<span id="cb3-120"><a href="#cb3-120" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span><span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> mu<span class="op">.</span>n_elem<span class="op">;</span> <span class="op">++</span>i<span class="op">){</span></span>
<span id="cb3-121"><a href="#cb3-121" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> mu_i <span class="op">=</span><span class="dv">0</span><span class="op">;</span></span>
<span id="cb3-122"><a href="#cb3-122" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> j <span class="op">=</span><span class="dv">0</span><span class="op">;</span> j <span class="op">&lt;</span> X<span class="op">.</span>n_elem<span class="op">;</span> <span class="op">++</span>j<span class="op">){</span></span>
<span id="cb3-123"><a href="#cb3-123" aria-hidden="true" tabindex="-1"></a>      <span class="co">// mising weight</span></span>
<span id="cb3-124"><a href="#cb3-124" aria-hidden="true" tabindex="-1"></a>      mu_i<span class="op">=</span>mu_i<span class="op">+</span>w_x<span class="op">(</span>j<span class="op">,</span>i<span class="op">)*(</span>X<span class="op">[</span>j<span class="op">]-</span>mu<span class="op">[</span>i<span class="op">])/(</span>Nu<span class="op">[</span>i<span class="op">]*</span>pow<span class="op">(</span>Sigma<span class="op">[</span>i<span class="op">],</span><span class="dv">2</span><span class="op">)+</span>pow<span class="op">(</span>X<span class="op">[</span>j<span class="op">]-</span>mu<span class="op">[</span>i<span class="op">],</span><span class="dv">2</span><span class="op">));</span></span>
<span id="cb3-125"><a href="#cb3-125" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb3-126"><a href="#cb3-126" aria-hidden="true" tabindex="-1"></a>    mu_i <span class="op">=</span> mu_i<span class="op">*(</span>Nu<span class="op">[</span>i<span class="op">]+</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb3-127"><a href="#cb3-127" aria-hidden="true" tabindex="-1"></a>    mu_i <span class="op">=-</span>mu_i<span class="op">;</span> </span>
<span id="cb3-128"><a href="#cb3-128" aria-hidden="true" tabindex="-1"></a>    Gradiets<span class="op">(</span>i<span class="op">,</span><span class="dv">0</span><span class="op">)=</span>mu_i<span class="op">;</span></span>
<span id="cb3-129"><a href="#cb3-129" aria-hidden="true" tabindex="-1"></a>  <span class="co">// sigma</span></span>
<span id="cb3-130"><a href="#cb3-130" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> sigma_i<span class="op">=</span><span class="dv">0</span><span class="op">;</span></span>
<span id="cb3-131"><a href="#cb3-131" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> j <span class="op">=</span><span class="dv">0</span><span class="op">;</span> j <span class="op">&lt;</span> X<span class="op">.</span>n_elem<span class="op">;</span> <span class="op">++</span>j<span class="op">){</span></span>
<span id="cb3-132"><a href="#cb3-132" aria-hidden="true" tabindex="-1"></a>      sigma_i<span class="op">=</span> sigma_i<span class="op">+</span>w_x<span class="op">(</span>j<span class="op">,</span>i<span class="op">)*(-</span><span class="dv">1</span><span class="op">+(</span>Nu<span class="op">[</span>i<span class="op">]+</span><span class="dv">1</span><span class="op">)*</span>pow<span class="op">(</span>X<span class="op">[</span>j<span class="op">]-</span>mu<span class="op">[</span>i<span class="op">],</span><span class="dv">2</span><span class="op">)/(</span>Sigma<span class="op">[</span>i<span class="op">]*</span>Nu<span class="op">[</span>i<span class="op">]+</span>pow<span class="op">(</span>X<span class="op">[</span>j<span class="op">]-</span>mu<span class="op">[</span>i<span class="op">],</span><span class="dv">2</span><span class="op">)));</span></span>
<span id="cb3-133"><a href="#cb3-133" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb3-134"><a href="#cb3-134" aria-hidden="true" tabindex="-1"></a>    sigma_i<span class="op">=</span>sigma_i<span class="op">/</span>Sigma<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb3-135"><a href="#cb3-135" aria-hidden="true" tabindex="-1"></a>    sigma_i<span class="op">=-</span>sigma_i<span class="op">;</span></span>
<span id="cb3-136"><a href="#cb3-136" aria-hidden="true" tabindex="-1"></a>    Gradiets<span class="op">(</span>i<span class="op">,</span><span class="dv">1</span><span class="op">)=</span>sigma_i<span class="op">;</span></span>
<span id="cb3-137"><a href="#cb3-137" aria-hidden="true" tabindex="-1"></a>    <span class="co">// nu</span></span>
<span id="cb3-138"><a href="#cb3-138" aria-hidden="true" tabindex="-1"></a>    <span class="co">// declare varibels for less coput</span></span>
<span id="cb3-139"><a href="#cb3-139" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> Gamma_v_plus_one<span class="op">=</span> tgamma<span class="op">((</span>Nu<span class="op">[</span>i<span class="op">]+</span><span class="dv">1</span><span class="op">)/</span><span class="dv">2</span><span class="op">);</span></span>
<span id="cb3-140"><a href="#cb3-140" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> psi_v_plus_one<span class="op">=</span> gsl_sf_psi<span class="op">((</span>Nu<span class="op">[</span>i<span class="op">]+</span><span class="dv">1</span><span class="op">)/</span><span class="dv">2</span><span class="op">);</span></span>
<span id="cb3-141"><a href="#cb3-141" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> Gamma_v <span class="op">=</span> tgamma<span class="op">(</span>Nu<span class="op">[</span>i<span class="op">]/</span><span class="dv">2</span><span class="op">);</span></span>
<span id="cb3-142"><a href="#cb3-142" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> psi_v <span class="op">=</span> gsl_sf_psi<span class="op">(</span>Nu<span class="op">[</span>i<span class="op">]/</span><span class="dv">2</span><span class="op">);</span></span>
<span id="cb3-143"><a href="#cb3-143" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> nu_i<span class="op">=</span><span class="dv">0</span><span class="op">;</span></span>
<span id="cb3-144"><a href="#cb3-144" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> j <span class="op">=</span><span class="dv">0</span><span class="op">;</span>j <span class="op">&lt;</span> X<span class="op">.</span>n_elem<span class="op">;++</span>j<span class="op">){</span></span>
<span id="cb3-145"><a href="#cb3-145" aria-hidden="true" tabindex="-1"></a>      nu_i<span class="op">=</span>nu_i<span class="op">-</span><span class="fl">0.5</span><span class="op">*</span>w_x<span class="op">(</span>j<span class="op">,</span>i<span class="op">)+((</span>Nu<span class="op">[</span>i<span class="op">]+</span><span class="dv">1</span><span class="op">)/</span><span class="dv">2</span><span class="op">)*((</span>pow<span class="op">(</span>X<span class="op">[</span>j<span class="op">]-</span>mu<span class="op">[</span>i<span class="op">],</span><span class="dv">2</span><span class="op">))/(</span>pow<span class="op">(</span>Sigma<span class="op">[</span>i<span class="op">]*</span>Nu<span class="op">[</span>i<span class="op">],</span><span class="dv">2</span><span class="op">)))*</span>w_x<span class="op">(</span>j<span class="op">,</span>i<span class="op">)+((</span>psi_v_plus_one<span class="op">)/(</span><span class="dv">2</span><span class="op">*</span>Gamma_v_plus_one<span class="op">))*</span>w_x<span class="op">(</span>j<span class="op">,</span>i<span class="op">)-((</span>psi_v<span class="op">)/(</span><span class="dv">2</span><span class="op">*</span>Gamma_v<span class="op">))*</span>w_x<span class="op">(</span>j<span class="op">,</span>i<span class="op">);</span></span>
<span id="cb3-146"><a href="#cb3-146" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb3-147"><a href="#cb3-147" aria-hidden="true" tabindex="-1"></a>    nu_i<span class="op">=-</span>nu_i<span class="op">;</span></span>
<span id="cb3-148"><a href="#cb3-148" aria-hidden="true" tabindex="-1"></a>    Gradiets<span class="op">(</span>i<span class="op">,</span><span class="dv">2</span><span class="op">)=</span>nu_i<span class="op">;</span></span>
<span id="cb3-149"><a href="#cb3-149" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb3-150"><a href="#cb3-150" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Gradient normalsation</span></span>
<span id="cb3-151"><a href="#cb3-151" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>normalise <span class="op">==</span><span class="st">"second_norm"</span><span class="op">){</span></span>
<span id="cb3-152"><a href="#cb3-152" aria-hidden="true" tabindex="-1"></a>    Gradiets<span class="op">=</span>Gradiets<span class="op">/</span>norm<span class="op">(</span>Gradiets<span class="op">,</span><span class="dv">2</span><span class="op">);</span> <span class="co">// second option based on dataX.n_elem;</span></span>
<span id="cb3-153"><a href="#cb3-153" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb3-154"><a href="#cb3-154" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>normalise <span class="op">==</span><span class="st">"N_element"</span><span class="op">){</span></span>
<span id="cb3-155"><a href="#cb3-155" aria-hidden="true" tabindex="-1"></a>    Gradiets<span class="op">=</span>Gradiets<span class="op">/</span>X<span class="op">.</span>n_elem<span class="op">;</span></span>
<span id="cb3-156"><a href="#cb3-156" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb3-157"><a href="#cb3-157" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>normalise <span class="op">==</span><span class="st">"Element_wise_Normalsation"</span><span class="op">){</span></span>
<span id="cb3-158"><a href="#cb3-158" aria-hidden="true" tabindex="-1"></a>    Gradiets<span class="op">=</span>Gradiets<span class="op">.</span>col<span class="op">(</span><span class="dv">0</span><span class="op">)/</span>norm<span class="op">(</span>Gradiets<span class="op">.</span>col<span class="op">(</span><span class="dv">0</span><span class="op">),</span><span class="dv">2</span><span class="op">);</span></span>
<span id="cb3-159"><a href="#cb3-159" aria-hidden="true" tabindex="-1"></a>    Gradiets<span class="op">=</span>Gradiets<span class="op">.</span>col<span class="op">(</span><span class="dv">1</span><span class="op">)/</span>norm<span class="op">(</span>Gradiets<span class="op">.</span>col<span class="op">(</span><span class="dv">1</span><span class="op">),</span><span class="dv">2</span><span class="op">);</span></span>
<span id="cb3-160"><a href="#cb3-160" aria-hidden="true" tabindex="-1"></a>    Gradiets<span class="op">=</span>Gradiets<span class="op">.</span>col<span class="op">(</span><span class="dv">2</span><span class="op">)/</span>norm<span class="op">(</span>Gradiets<span class="op">.</span>col<span class="op">(</span><span class="dv">2</span><span class="op">),</span><span class="dv">2</span><span class="op">);</span></span>
<span id="cb3-161"><a href="#cb3-161" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb3-162"><a href="#cb3-162" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> Gradiets<span class="op">;</span></span>
<span id="cb3-163"><a href="#cb3-163" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb3-164"><a href="#cb3-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-165"><a href="#cb3-165" aria-hidden="true" tabindex="-1"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb3-166"><a href="#cb3-166" aria-hidden="true" tabindex="-1"></a>vec Maximum_of_two_vector<span class="op">(</span>vec v1<span class="op">,</span>vec v2<span class="op">){</span></span>
<span id="cb3-167"><a href="#cb3-167" aria-hidden="true" tabindex="-1"></a>  vec v_out<span class="op">(</span>v1<span class="op">.</span>n_elem<span class="op">);</span></span>
<span id="cb3-168"><a href="#cb3-168" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span><span class="op">(</span><span class="dt">int</span> i <span class="op">=</span><span class="dv">0</span><span class="op">;</span>i<span class="op">&lt;</span>v1<span class="op">.</span>n_elem<span class="op">;++</span>i<span class="op">){</span></span>
<span id="cb3-169"><a href="#cb3-169" aria-hidden="true" tabindex="-1"></a>    v_out<span class="op">[</span>i<span class="op">]=</span> max<span class="op">(</span>v1<span class="op">[</span>i<span class="op">],</span>v2<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb3-170"><a href="#cb3-170" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb3-171"><a href="#cb3-171" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> v_out<span class="op">;</span></span>
<span id="cb3-172"><a href="#cb3-172" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb3-173"><a href="#cb3-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-174"><a href="#cb3-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-175"><a href="#cb3-175" aria-hidden="true" tabindex="-1"></a><span class="co">//using overload to define to function based on the case where in</span></span>
<span id="cb3-176"><a href="#cb3-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-177"><a href="#cb3-177" aria-hidden="true" tabindex="-1"></a>mat Gradient_clipping_vec<span class="op">(</span>mat gradient<span class="op">,</span>vec C_levels<span class="op">=</span>vec<span class="op">(</span><span class="dv">3</span><span class="op">,</span><span class="fl">1.0</span><span class="op">)){</span></span>
<span id="cb3-178"><a href="#cb3-178" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span><span class="dv">0</span><span class="op">;</span>i<span class="op">&lt;</span>gradient<span class="op">.</span>n_cols<span class="op">;++</span>i<span class="op">){</span></span>
<span id="cb3-179"><a href="#cb3-179" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span><span class="op">(</span>norm<span class="op">(</span>gradient<span class="op">.</span>col<span class="op">(</span>i<span class="op">),</span><span class="dv">2</span><span class="op">)&gt;</span>C_levels<span class="op">[</span>i<span class="op">]){</span></span>
<span id="cb3-180"><a href="#cb3-180" aria-hidden="true" tabindex="-1"></a>      gradient<span class="op">.</span>col<span class="op">(</span>i<span class="op">)=</span>C_levels<span class="op">[</span>i<span class="op">]*</span>gradient<span class="op">.</span>col<span class="op">(</span>i<span class="op">)/</span>norm<span class="op">(</span>gradient<span class="op">.</span>col<span class="op">(</span>i<span class="op">),</span><span class="dv">2</span><span class="op">);</span></span>
<span id="cb3-181"><a href="#cb3-181" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb3-182"><a href="#cb3-182" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb3-183"><a href="#cb3-183" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span><span class="op">(</span>gradient<span class="op">);</span></span>
<span id="cb3-184"><a href="#cb3-184" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb3-185"><a href="#cb3-185" aria-hidden="true" tabindex="-1"></a>mat Gradient_clipping<span class="op">(</span>mat gradient<span class="op">,</span><span class="dt">double</span> C_level<span class="op">=</span><span class="dv">1</span><span class="op">){</span></span>
<span id="cb3-186"><a href="#cb3-186" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span><span class="op">(</span>norm<span class="op">(</span>gradient<span class="op">,</span><span class="dv">2</span><span class="op">)&gt;</span>C_level<span class="op">){</span></span>
<span id="cb3-187"><a href="#cb3-187" aria-hidden="true" tabindex="-1"></a>    gradient<span class="op">=</span>C_level<span class="op">*</span>gradient<span class="op">/</span>norm<span class="op">(</span>gradient<span class="op">,</span><span class="dv">2</span><span class="op">);</span></span>
<span id="cb3-188"><a href="#cb3-188" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb3-189"><a href="#cb3-189" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span><span class="op">(</span>gradient<span class="op">);</span></span>
<span id="cb3-190"><a href="#cb3-190" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb3-191"><a href="#cb3-191" aria-hidden="true" tabindex="-1"></a><span class="co">// Chosen not to export graident clibbing to R since i cant export to function with the same name.</span></span>
<span id="cb3-192"><a href="#cb3-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-193"><a href="#cb3-193" aria-hidden="true" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb3-194"><a href="#cb3-194" aria-hidden="true" tabindex="-1"></a><span class="co">I this section i have made multiple version of gradient decent.</span></span>
<span id="cb3-195"><a href="#cb3-195" aria-hidden="true" tabindex="-1"></a><span class="co">It could be combinede in to one function. I have keept it as threes versions so, since in the final EM one is gona be called as the standart.</span></span>
<span id="cb3-196"><a href="#cb3-196" aria-hidden="true" tabindex="-1"></a><span class="co">So insted of investing af lot time to writing it, this makes the flow faster.</span></span>
<span id="cb3-197"><a href="#cb3-197" aria-hidden="true" tabindex="-1"></a><span class="co">*/</span></span>
<span id="cb3-198"><a href="#cb3-198" aria-hidden="true" tabindex="-1"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb3-199"><a href="#cb3-199" aria-hidden="true" tabindex="-1"></a>mat gradient_decent_no_check<span class="op">(</span>vec X<span class="op">,</span></span>
<span id="cb3-200"><a href="#cb3-200" aria-hidden="true" tabindex="-1"></a>                                   vec Pi<span class="op">,</span></span>
<span id="cb3-201"><a href="#cb3-201" aria-hidden="true" tabindex="-1"></a>                                   vec mu<span class="op">,</span></span>
<span id="cb3-202"><a href="#cb3-202" aria-hidden="true" tabindex="-1"></a>                                   vec Sigma<span class="op">,</span></span>
<span id="cb3-203"><a href="#cb3-203" aria-hidden="true" tabindex="-1"></a>                                   vec Nu<span class="op">,</span></span>
<span id="cb3-204"><a href="#cb3-204" aria-hidden="true" tabindex="-1"></a>                                   <span class="dt">double</span> alpha<span class="op">=</span><span class="fl">0.02</span><span class="op">,</span></span>
<span id="cb3-205"><a href="#cb3-205" aria-hidden="true" tabindex="-1"></a>                                   <span class="dt">double</span> Max_iter<span class="op">=</span><span class="dv">1000</span><span class="op">,</span></span>
<span id="cb3-206"><a href="#cb3-206" aria-hidden="true" tabindex="-1"></a>                                   <span class="dt">double</span> norm_gradient <span class="op">=</span> <span class="fl">0.5</span><span class="op">,</span></span>
<span id="cb3-207"><a href="#cb3-207" aria-hidden="true" tabindex="-1"></a>                                   string normalise_method <span class="op">=</span><span class="st">"no_normaliztion"</span><span class="co">//this should be changed</span></span>
<span id="cb3-208"><a href="#cb3-208" aria-hidden="true" tabindex="-1"></a>                               <span class="op">)</span></span>
<span id="cb3-209"><a href="#cb3-209" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span></span>
<span id="cb3-210"><a href="#cb3-210" aria-hidden="true" tabindex="-1"></a>  mat parameters<span class="op">(</span>Pi<span class="op">.</span>n_elem<span class="op">,</span><span class="dv">3</span><span class="op">);</span> </span>
<span id="cb3-211"><a href="#cb3-211" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Set parameters value in matrix form (esay to update)</span></span>
<span id="cb3-212"><a href="#cb3-212" aria-hidden="true" tabindex="-1"></a>  parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">0</span><span class="op">)=</span>mu<span class="op">;</span></span>
<span id="cb3-213"><a href="#cb3-213" aria-hidden="true" tabindex="-1"></a>  parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">1</span><span class="op">)=</span>Sigma<span class="op">;</span></span>
<span id="cb3-214"><a href="#cb3-214" aria-hidden="true" tabindex="-1"></a>  parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">2</span><span class="op">)=</span>Nu<span class="op">;</span></span>
<span id="cb3-215"><a href="#cb3-215" aria-hidden="true" tabindex="-1"></a>  mat gradient_in_point <span class="op">=</span> gradient<span class="op">(</span>X<span class="op">,</span>Pi<span class="op">,</span>parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">0</span><span class="op">),</span>parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">1</span><span class="op">),</span>parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">2</span><span class="op">),</span>normalise_method<span class="op">);</span> </span>
<span id="cb3-216"><a href="#cb3-216" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-217"><a href="#cb3-217" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Sigma_lower_bound_vec</span></span>
<span id="cb3-218"><a href="#cb3-218" aria-hidden="true" tabindex="-1"></a>  <span class="co">/*</span></span>
<span id="cb3-219"><a href="#cb3-219" aria-hidden="true" tabindex="-1"></a><span class="co">  This is smart since it the if one overshoot the domain of the Gamma function is not definede </span></span>
<span id="cb3-220"><a href="#cb3-220" aria-hidden="true" tabindex="-1"></a><span class="co">  */</span></span>
<span id="cb3-221"><a href="#cb3-221" aria-hidden="true" tabindex="-1"></a>  <span class="dt">double</span> parameter_min<span class="op">=</span> <span class="fl">0.01</span><span class="op">;</span></span>
<span id="cb3-222"><a href="#cb3-222" aria-hidden="true" tabindex="-1"></a>  vec Sigma_lower_bound_vec<span class="op">(</span>Sigma<span class="op">.</span>n_elem<span class="op">,</span>fill<span class="op">::</span>ones<span class="op">);</span></span>
<span id="cb3-223"><a href="#cb3-223" aria-hidden="true" tabindex="-1"></a>  Sigma_lower_bound_vec<span class="op">=</span>parameter_min<span class="op">*</span>Sigma_lower_bound_vec<span class="op">;</span></span>
<span id="cb3-224"><a href="#cb3-224" aria-hidden="true" tabindex="-1"></a>  vec Nu_lower_bound_vec<span class="op">(</span>Nu<span class="op">.</span>n_elem<span class="op">,</span>fill<span class="op">::</span>ones<span class="op">);</span></span>
<span id="cb3-225"><a href="#cb3-225" aria-hidden="true" tabindex="-1"></a>  Nu_lower_bound_vec<span class="op">=</span>parameter_min<span class="op">*</span>Nu_lower_bound_vec<span class="op">;</span></span>
<span id="cb3-226"><a href="#cb3-226" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-227"><a href="#cb3-227" aria-hidden="true" tabindex="-1"></a>  <span class="co">// loop throug gradient decent</span></span>
<span id="cb3-228"><a href="#cb3-228" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i<span class="op">=</span><span class="dv">0</span><span class="op">;</span>i<span class="op">&lt;</span>Max_iter<span class="op">;++</span>i<span class="op">){</span></span>
<span id="cb3-229"><a href="#cb3-229" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>norm<span class="op">(</span>vectorise<span class="op">(</span>gradient<span class="op">(</span>X<span class="op">,</span>Pi<span class="op">,</span>parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">0</span><span class="op">),</span>parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">1</span><span class="op">),</span>parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">2</span><span class="op">),</span><span class="st">"no_normaliztion"</span><span class="op">)),</span><span class="dv">2</span><span class="op">)&lt;</span>norm_gradient<span class="op">){</span></span>
<span id="cb3-230"><a href="#cb3-230" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> parameters<span class="op">;</span></span>
<span id="cb3-231"><a href="#cb3-231" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb3-232"><a href="#cb3-232" aria-hidden="true" tabindex="-1"></a>    parameters<span class="op">=</span>parameters<span class="op">-</span>alpha<span class="op">*</span>gradient_in_point<span class="op">;</span></span>
<span id="cb3-233"><a href="#cb3-233" aria-hidden="true" tabindex="-1"></a>    <span class="co">// If undershoot set to minimum Note is is importante that the check is done before the gradient is updated, otherwise the gradient will not be able to be evaluated</span></span>
<span id="cb3-234"><a href="#cb3-234" aria-hidden="true" tabindex="-1"></a>    parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">1</span><span class="op">)=</span>Maximum_of_two_vector<span class="op">(</span>parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">1</span><span class="op">),</span>Sigma_lower_bound_vec<span class="op">);</span></span>
<span id="cb3-235"><a href="#cb3-235" aria-hidden="true" tabindex="-1"></a>    parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">2</span><span class="op">)=</span>Maximum_of_two_vector<span class="op">(</span>parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">2</span><span class="op">),</span>Nu_lower_bound_vec<span class="op">);</span></span>
<span id="cb3-236"><a href="#cb3-236" aria-hidden="true" tabindex="-1"></a>    <span class="co">// update parametes</span></span>
<span id="cb3-237"><a href="#cb3-237" aria-hidden="true" tabindex="-1"></a>    gradient_in_point <span class="op">=</span> gradient<span class="op">(</span>X<span class="op">,</span>Pi<span class="op">,</span>parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">0</span><span class="op">),</span>parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">1</span><span class="op">),</span>parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">2</span><span class="op">),</span>normalise_method<span class="op">);</span></span>
<span id="cb3-238"><a href="#cb3-238" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-239"><a href="#cb3-239" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb3-240"><a href="#cb3-240" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> parameters<span class="op">;</span></span>
<span id="cb3-241"><a href="#cb3-241" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb3-242"><a href="#cb3-242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-243"><a href="#cb3-243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-244"><a href="#cb3-244" aria-hidden="true" tabindex="-1"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb3-245"><a href="#cb3-245" aria-hidden="true" tabindex="-1"></a>mat gradient_decent_with_check<span class="op">(</span>vec X<span class="op">,</span></span>
<span id="cb3-246"><a href="#cb3-246" aria-hidden="true" tabindex="-1"></a>                             vec Pi<span class="op">,</span></span>
<span id="cb3-247"><a href="#cb3-247" aria-hidden="true" tabindex="-1"></a>                             vec mu<span class="op">,</span></span>
<span id="cb3-248"><a href="#cb3-248" aria-hidden="true" tabindex="-1"></a>                             vec Sigma<span class="op">,</span></span>
<span id="cb3-249"><a href="#cb3-249" aria-hidden="true" tabindex="-1"></a>                             vec Nu<span class="op">,</span></span>
<span id="cb3-250"><a href="#cb3-250" aria-hidden="true" tabindex="-1"></a>                             <span class="dt">double</span> alpha<span class="op">=</span><span class="fl">0.02</span><span class="op">,</span></span>
<span id="cb3-251"><a href="#cb3-251" aria-hidden="true" tabindex="-1"></a>                             <span class="dt">double</span> Max_iter<span class="op">=</span><span class="dv">1000</span><span class="op">,</span></span>
<span id="cb3-252"><a href="#cb3-252" aria-hidden="true" tabindex="-1"></a>                             <span class="dt">double</span> norm_gradient <span class="op">=</span> <span class="fl">0.5</span><span class="op">,</span></span>
<span id="cb3-253"><a href="#cb3-253" aria-hidden="true" tabindex="-1"></a>                             string normalise_method <span class="op">=</span><span class="st">"no_normaliztion"</span><span class="op">,</span><span class="co">//this should be changed</span></span>
<span id="cb3-254"><a href="#cb3-254" aria-hidden="true" tabindex="-1"></a>                             <span class="dt">double</span> max_it_in_check<span class="op">=</span> <span class="dv">10</span></span>
<span id="cb3-255"><a href="#cb3-255" aria-hidden="true" tabindex="-1"></a>                            <span class="op">)</span></span>
<span id="cb3-256"><a href="#cb3-256" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb3-257"><a href="#cb3-257" aria-hidden="true" tabindex="-1"></a>  mat parameters<span class="op">(</span>Pi<span class="op">.</span>n_elem<span class="op">,</span><span class="dv">3</span><span class="op">);</span> </span>
<span id="cb3-258"><a href="#cb3-258" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Set parameters value in matrix form (esay to update)</span></span>
<span id="cb3-259"><a href="#cb3-259" aria-hidden="true" tabindex="-1"></a>  parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">0</span><span class="op">)=</span>mu<span class="op">;</span></span>
<span id="cb3-260"><a href="#cb3-260" aria-hidden="true" tabindex="-1"></a>  parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">1</span><span class="op">)=</span>Sigma<span class="op">;</span></span>
<span id="cb3-261"><a href="#cb3-261" aria-hidden="true" tabindex="-1"></a>  parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">2</span><span class="op">)=</span>Nu<span class="op">;</span></span>
<span id="cb3-262"><a href="#cb3-262" aria-hidden="true" tabindex="-1"></a>  mat gradient_in_point <span class="op">=</span> gradient<span class="op">(</span>X<span class="op">,</span>Pi<span class="op">,</span>parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">0</span><span class="op">),</span>parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">1</span><span class="op">),</span>parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">2</span><span class="op">),</span>normalise_method<span class="op">);</span> </span>
<span id="cb3-263"><a href="#cb3-263" aria-hidden="true" tabindex="-1"></a>  <span class="co">// make teperay variabel</span></span>
<span id="cb3-264"><a href="#cb3-264" aria-hidden="true" tabindex="-1"></a>  mat tem_parameters<span class="op">=</span>parameters<span class="op">;</span></span>
<span id="cb3-265"><a href="#cb3-265" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Sigma_lower_bound_ve</span></span>
<span id="cb3-266"><a href="#cb3-266" aria-hidden="true" tabindex="-1"></a>  <span class="dt">double</span> parameter_min<span class="op">=</span> <span class="fl">0.01</span><span class="op">;</span></span>
<span id="cb3-267"><a href="#cb3-267" aria-hidden="true" tabindex="-1"></a>  vec Sigma_lower_bound_vec<span class="op">(</span>Sigma<span class="op">.</span>n_elem<span class="op">,</span>fill<span class="op">::</span>ones<span class="op">);</span></span>
<span id="cb3-268"><a href="#cb3-268" aria-hidden="true" tabindex="-1"></a>  Sigma_lower_bound_vec<span class="op">=</span>parameter_min<span class="op">*</span>Sigma_lower_bound_vec<span class="op">;</span></span>
<span id="cb3-269"><a href="#cb3-269" aria-hidden="true" tabindex="-1"></a>  vec Nu_lower_bound_vec<span class="op">(</span>Nu<span class="op">.</span>n_elem<span class="op">,</span>fill<span class="op">::</span>ones<span class="op">);</span></span>
<span id="cb3-270"><a href="#cb3-270" aria-hidden="true" tabindex="-1"></a>  Nu_lower_bound_vec<span class="op">=</span>parameter_min<span class="op">*</span>Nu_lower_bound_vec<span class="op">;</span></span>
<span id="cb3-271"><a href="#cb3-271" aria-hidden="true" tabindex="-1"></a>  <span class="co">// loop throug gradient decent</span></span>
<span id="cb3-272"><a href="#cb3-272" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i<span class="op">=</span><span class="dv">0</span><span class="op">;</span>i<span class="op">&lt;</span>Max_iter<span class="op">;++</span>i<span class="op">){</span></span>
<span id="cb3-273"><a href="#cb3-273" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>norm<span class="op">(</span>vectorise<span class="op">(</span>gradient<span class="op">(</span>X<span class="op">,</span>Pi<span class="op">,</span>parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">0</span><span class="op">),</span>parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">1</span><span class="op">),</span>parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">2</span><span class="op">),</span><span class="st">"no_normaliztion"</span><span class="op">)),</span><span class="dv">2</span><span class="op">)&lt;</span>norm_gradient<span class="op">){</span></span>
<span id="cb3-274"><a href="#cb3-274" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> parameters<span class="op">;</span></span>
<span id="cb3-275"><a href="#cb3-275" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb3-276"><a href="#cb3-276" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span><span class="op">(</span><span class="dt">int</span> j<span class="op">=</span><span class="dv">0</span><span class="op">;</span>j<span class="op">&lt;</span>max_it_in_check<span class="op">;</span>j<span class="op">++){</span></span>
<span id="cb3-277"><a href="#cb3-277" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span><span class="op">(</span>likelyhood_t_mix<span class="op">(</span>X<span class="op">,</span>Pi<span class="op">,</span>parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">0</span><span class="op">),</span>parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">1</span><span class="op">),</span>parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">2</span><span class="op">))&lt;</span>likelyhood_t_mix<span class="op">(</span>X<span class="op">,</span>Pi<span class="op">,</span>tem_parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">0</span><span class="op">),</span>tem_parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">1</span><span class="op">),</span>tem_parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">2</span><span class="op">))){</span></span>
<span id="cb3-278"><a href="#cb3-278" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb3-279"><a href="#cb3-279" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb3-280"><a href="#cb3-280" aria-hidden="true" tabindex="-1"></a>      tem_parameters<span class="op">=</span>parameters<span class="op">-</span>alpha<span class="op">*</span>gradient_in_point<span class="op">;</span></span>
<span id="cb3-281"><a href="#cb3-281" aria-hidden="true" tabindex="-1"></a>      gradient_in_point<span class="op">=</span>alpha<span class="op">*</span>gradient_in_point<span class="op">;</span></span>
<span id="cb3-282"><a href="#cb3-282" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb3-283"><a href="#cb3-283" aria-hidden="true" tabindex="-1"></a>    parameters<span class="op">=</span>tem_parameters<span class="op">;</span></span>
<span id="cb3-284"><a href="#cb3-284" aria-hidden="true" tabindex="-1"></a>    <span class="co">// If undershoot set to minimum Note is is importante that the check is done before the gradient is updated, otherwise the gradient will not be able to be evaluated</span></span>
<span id="cb3-285"><a href="#cb3-285" aria-hidden="true" tabindex="-1"></a>    parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">1</span><span class="op">)=</span>Maximum_of_two_vector<span class="op">(</span>parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">1</span><span class="op">),</span>Sigma_lower_bound_vec<span class="op">);</span></span>
<span id="cb3-286"><a href="#cb3-286" aria-hidden="true" tabindex="-1"></a>    parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">2</span><span class="op">)=</span>Maximum_of_two_vector<span class="op">(</span>parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">2</span><span class="op">),</span>Nu_lower_bound_vec<span class="op">);</span></span>
<span id="cb3-287"><a href="#cb3-287" aria-hidden="true" tabindex="-1"></a>    <span class="co">// update parametes</span></span>
<span id="cb3-288"><a href="#cb3-288" aria-hidden="true" tabindex="-1"></a>    gradient_in_point <span class="op">=</span> gradient<span class="op">(</span>X<span class="op">,</span>Pi<span class="op">,</span>parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">0</span><span class="op">),</span>parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">1</span><span class="op">),</span>parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">2</span><span class="op">),</span>normalise_method<span class="op">);</span></span>
<span id="cb3-289"><a href="#cb3-289" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-290"><a href="#cb3-290" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb3-291"><a href="#cb3-291" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> parameters<span class="op">;</span></span>
<span id="cb3-292"><a href="#cb3-292" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb3-293"><a href="#cb3-293" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-294"><a href="#cb3-294" aria-hidden="true" tabindex="-1"></a><span class="co">// need to be made</span></span>
<span id="cb3-295"><a href="#cb3-295" aria-hidden="true" tabindex="-1"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb3-296"><a href="#cb3-296" aria-hidden="true" tabindex="-1"></a>mat gradient_decent_T_mix_model<span class="op">(</span>vec X<span class="op">,</span></span>
<span id="cb3-297"><a href="#cb3-297" aria-hidden="true" tabindex="-1"></a>                               vec Pi<span class="op">,</span></span>
<span id="cb3-298"><a href="#cb3-298" aria-hidden="true" tabindex="-1"></a>                               vec mu<span class="op">,</span></span>
<span id="cb3-299"><a href="#cb3-299" aria-hidden="true" tabindex="-1"></a>                               vec Sigma<span class="op">,</span></span>
<span id="cb3-300"><a href="#cb3-300" aria-hidden="true" tabindex="-1"></a>                               vec Nu<span class="op">,</span></span>
<span id="cb3-301"><a href="#cb3-301" aria-hidden="true" tabindex="-1"></a>                               <span class="dt">double</span> alpha<span class="op">=</span><span class="fl">0.02</span><span class="op">,</span></span>
<span id="cb3-302"><a href="#cb3-302" aria-hidden="true" tabindex="-1"></a>                               <span class="dt">double</span> Max_iter<span class="op">=</span><span class="dv">1000</span><span class="op">,</span></span>
<span id="cb3-303"><a href="#cb3-303" aria-hidden="true" tabindex="-1"></a>                               <span class="dt">double</span> norm_gradient <span class="op">=</span> <span class="fl">0.5</span><span class="op">,</span></span>
<span id="cb3-304"><a href="#cb3-304" aria-hidden="true" tabindex="-1"></a>                               string type_decent <span class="op">=</span><span class="st">"Normal"</span><span class="op">,</span></span>
<span id="cb3-305"><a href="#cb3-305" aria-hidden="true" tabindex="-1"></a>                               string normalise_method <span class="op">=</span><span class="st">"no_normaliztion"</span><span class="op">,</span><span class="co">//this should be changed</span></span>
<span id="cb3-306"><a href="#cb3-306" aria-hidden="true" tabindex="-1"></a>                               <span class="dt">double</span> max_it_in_check<span class="op">=</span> <span class="dv">10</span></span>
<span id="cb3-307"><a href="#cb3-307" aria-hidden="true" tabindex="-1"></a>                               </span>
<span id="cb3-308"><a href="#cb3-308" aria-hidden="true" tabindex="-1"></a><span class="op">)</span></span>
<span id="cb3-309"><a href="#cb3-309" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb3-310"><a href="#cb3-310" aria-hidden="true" tabindex="-1"></a>  mat parameters<span class="op">(</span>Pi<span class="op">.</span>n_elem<span class="op">,</span><span class="dv">3</span><span class="op">);</span> </span>
<span id="cb3-311"><a href="#cb3-311" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Set parameters value in matrix form (esay to update)</span></span>
<span id="cb3-312"><a href="#cb3-312" aria-hidden="true" tabindex="-1"></a>  parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">0</span><span class="op">)=</span>mu<span class="op">;</span></span>
<span id="cb3-313"><a href="#cb3-313" aria-hidden="true" tabindex="-1"></a>  parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">1</span><span class="op">)=</span>Sigma<span class="op">;</span></span>
<span id="cb3-314"><a href="#cb3-314" aria-hidden="true" tabindex="-1"></a>  parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">2</span><span class="op">)=</span>Nu<span class="op">;</span></span>
<span id="cb3-315"><a href="#cb3-315" aria-hidden="true" tabindex="-1"></a>  mat gradient_in_point <span class="op">=</span> gradient<span class="op">(</span>X<span class="op">,</span>Pi<span class="op">,</span>parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">0</span><span class="op">),</span>parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">1</span><span class="op">),</span>parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">2</span><span class="op">),</span>normalise_method<span class="op">);</span> </span>
<span id="cb3-316"><a href="#cb3-316" aria-hidden="true" tabindex="-1"></a>  <span class="co">// make teperay variabel</span></span>
<span id="cb3-317"><a href="#cb3-317" aria-hidden="true" tabindex="-1"></a>  mat tem_parameters<span class="op">=</span>parameters<span class="op">;</span></span>
<span id="cb3-318"><a href="#cb3-318" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Sigma_lower_bound_ve</span></span>
<span id="cb3-319"><a href="#cb3-319" aria-hidden="true" tabindex="-1"></a>  <span class="dt">double</span> parameter_min<span class="op">=</span> <span class="fl">0.01</span><span class="op">;</span></span>
<span id="cb3-320"><a href="#cb3-320" aria-hidden="true" tabindex="-1"></a>  vec Sigma_lower_bound_vec<span class="op">(</span>Sigma<span class="op">.</span>n_elem<span class="op">,</span>fill<span class="op">::</span>ones<span class="op">);</span></span>
<span id="cb3-321"><a href="#cb3-321" aria-hidden="true" tabindex="-1"></a>  Sigma_lower_bound_vec<span class="op">=</span>parameter_min<span class="op">*</span>Sigma_lower_bound_vec<span class="op">;</span></span>
<span id="cb3-322"><a href="#cb3-322" aria-hidden="true" tabindex="-1"></a>  vec Nu_lower_bound_vec<span class="op">(</span>Nu<span class="op">.</span>n_elem<span class="op">,</span>fill<span class="op">::</span>ones<span class="op">);</span></span>
<span id="cb3-323"><a href="#cb3-323" aria-hidden="true" tabindex="-1"></a>  Nu_lower_bound_vec<span class="op">=</span>parameter_min<span class="op">*</span>Nu_lower_bound_vec<span class="op">;</span></span>
<span id="cb3-324"><a href="#cb3-324" aria-hidden="true" tabindex="-1"></a>  <span class="co">// loop throug gradient decent</span></span>
<span id="cb3-325"><a href="#cb3-325" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i<span class="op">=</span><span class="dv">0</span><span class="op">;</span>i<span class="op">&lt;</span>Max_iter<span class="op">;++</span>i<span class="op">){</span></span>
<span id="cb3-326"><a href="#cb3-326" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>norm<span class="op">(</span>vectorise<span class="op">(</span>gradient<span class="op">(</span>X<span class="op">,</span>Pi<span class="op">,</span>parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">0</span><span class="op">),</span>parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">1</span><span class="op">),</span>parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">2</span><span class="op">),</span><span class="st">"no_normaliztion"</span><span class="op">)),</span><span class="dv">2</span><span class="op">)&lt;</span>norm_gradient<span class="op">){</span></span>
<span id="cb3-327"><a href="#cb3-327" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> parameters<span class="op">;</span></span>
<span id="cb3-328"><a href="#cb3-328" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb3-329"><a href="#cb3-329" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span><span class="op">(</span><span class="dt">int</span> j<span class="op">=</span><span class="dv">0</span><span class="op">;</span>j<span class="op">&lt;</span>max_it_in_check<span class="op">;</span>j<span class="op">++){</span></span>
<span id="cb3-330"><a href="#cb3-330" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span><span class="op">(</span>likelyhood_t_mix<span class="op">(</span>X<span class="op">,</span>Pi<span class="op">,</span>parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">0</span><span class="op">),</span>parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">1</span><span class="op">),</span>parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">2</span><span class="op">))&lt;</span>likelyhood_t_mix<span class="op">(</span>X<span class="op">,</span>Pi<span class="op">,</span>tem_parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">0</span><span class="op">),</span>tem_parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">1</span><span class="op">),</span>tem_parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">2</span><span class="op">))){</span></span>
<span id="cb3-331"><a href="#cb3-331" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb3-332"><a href="#cb3-332" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb3-333"><a href="#cb3-333" aria-hidden="true" tabindex="-1"></a>      tem_parameters<span class="op">=</span>parameters<span class="op">-</span>alpha<span class="op">*</span>gradient_in_point<span class="op">;</span></span>
<span id="cb3-334"><a href="#cb3-334" aria-hidden="true" tabindex="-1"></a>      gradient_in_point<span class="op">=</span>alpha<span class="op">*</span>gradient_in_point<span class="op">;</span></span>
<span id="cb3-335"><a href="#cb3-335" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb3-336"><a href="#cb3-336" aria-hidden="true" tabindex="-1"></a>    parameters<span class="op">=</span>tem_parameters<span class="op">;</span></span>
<span id="cb3-337"><a href="#cb3-337" aria-hidden="true" tabindex="-1"></a>    <span class="co">// If undershoot set to minimum Note is is importante that the check is done before the gradient is updated, otherwise the gradient will not be able to be evaluated</span></span>
<span id="cb3-338"><a href="#cb3-338" aria-hidden="true" tabindex="-1"></a>    parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">1</span><span class="op">)=</span>Maximum_of_two_vector<span class="op">(</span>parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">1</span><span class="op">),</span>Sigma_lower_bound_vec<span class="op">);</span></span>
<span id="cb3-339"><a href="#cb3-339" aria-hidden="true" tabindex="-1"></a>    parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">2</span><span class="op">)=</span>Maximum_of_two_vector<span class="op">(</span>parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">2</span><span class="op">),</span>Nu_lower_bound_vec<span class="op">);</span></span>
<span id="cb3-340"><a href="#cb3-340" aria-hidden="true" tabindex="-1"></a>    <span class="co">// update parametes</span></span>
<span id="cb3-341"><a href="#cb3-341" aria-hidden="true" tabindex="-1"></a>    gradient_in_point <span class="op">=</span> gradient<span class="op">(</span>X<span class="op">,</span>Pi<span class="op">,</span>parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">0</span><span class="op">),</span>parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">1</span><span class="op">),</span>parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">2</span><span class="op">),</span>normalise_method<span class="op">);</span></span>
<span id="cb3-342"><a href="#cb3-342" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-343"><a href="#cb3-343" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb3-344"><a href="#cb3-344" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> parameters<span class="op">;</span></span>
<span id="cb3-345"><a href="#cb3-345" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb3-346"><a href="#cb3-346" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-347"><a href="#cb3-347" aria-hidden="true" tabindex="-1"></a><span class="co">// Gradient decent whit clipping</span></span>
<span id="cb3-348"><a href="#cb3-348" aria-hidden="true" tabindex="-1"></a><span class="co">//</span></span>
<span id="cb3-349"><a href="#cb3-349" aria-hidden="true" tabindex="-1"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb3-350"><a href="#cb3-350" aria-hidden="true" tabindex="-1"></a>mat gradient_decent_with_clipping<span class="op">(</span>vec X<span class="op">,</span></span>
<span id="cb3-351"><a href="#cb3-351" aria-hidden="true" tabindex="-1"></a>                                vec Pi<span class="op">,</span></span>
<span id="cb3-352"><a href="#cb3-352" aria-hidden="true" tabindex="-1"></a>                                vec mu<span class="op">,</span></span>
<span id="cb3-353"><a href="#cb3-353" aria-hidden="true" tabindex="-1"></a>                                vec Sigma<span class="op">,</span></span>
<span id="cb3-354"><a href="#cb3-354" aria-hidden="true" tabindex="-1"></a>                                vec Nu<span class="op">,</span></span>
<span id="cb3-355"><a href="#cb3-355" aria-hidden="true" tabindex="-1"></a>                                vec Clipping_vector<span class="op">,</span></span>
<span id="cb3-356"><a href="#cb3-356" aria-hidden="true" tabindex="-1"></a>                                <span class="dt">double</span> alpha<span class="op">=</span><span class="fl">0.02</span><span class="op">,</span></span>
<span id="cb3-357"><a href="#cb3-357" aria-hidden="true" tabindex="-1"></a>                                <span class="dt">int</span> Max_iter<span class="op">=</span><span class="dv">1000</span><span class="op">,</span></span>
<span id="cb3-358"><a href="#cb3-358" aria-hidden="true" tabindex="-1"></a>                                <span class="dt">double</span> norm_gradient <span class="op">=</span> <span class="fl">0.5</span><span class="op">,</span></span>
<span id="cb3-359"><a href="#cb3-359" aria-hidden="true" tabindex="-1"></a>                                <span class="dt">int</span> max_it_in_check<span class="op">=</span> <span class="dv">10</span></span>
<span id="cb3-360"><a href="#cb3-360" aria-hidden="true" tabindex="-1"></a><span class="op">)</span></span>
<span id="cb3-361"><a href="#cb3-361" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb3-362"><a href="#cb3-362" aria-hidden="true" tabindex="-1"></a>  <span class="co">// make mat for parameters</span></span>
<span id="cb3-363"><a href="#cb3-363" aria-hidden="true" tabindex="-1"></a>  mat parameters<span class="op">(</span>Pi<span class="op">.</span>n_elem<span class="op">,</span><span class="dv">3</span><span class="op">);</span> </span>
<span id="cb3-364"><a href="#cb3-364" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-365"><a href="#cb3-365" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Set parameters value in matrix form (esay to update)</span></span>
<span id="cb3-366"><a href="#cb3-366" aria-hidden="true" tabindex="-1"></a>  parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">0</span><span class="op">)=</span>mu<span class="op">;</span></span>
<span id="cb3-367"><a href="#cb3-367" aria-hidden="true" tabindex="-1"></a>  parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">1</span><span class="op">)=</span>Sigma<span class="op">;</span></span>
<span id="cb3-368"><a href="#cb3-368" aria-hidden="true" tabindex="-1"></a>  parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">2</span><span class="op">)=</span>Nu<span class="op">;</span></span>
<span id="cb3-369"><a href="#cb3-369" aria-hidden="true" tabindex="-1"></a>  mat gradient_in_point <span class="op">=</span> gradient<span class="op">(</span>X<span class="op">,</span>Pi<span class="op">,</span>parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">0</span><span class="op">),</span>parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">1</span><span class="op">),</span>parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">2</span><span class="op">),</span><span class="st">"no_normaliztion"</span><span class="op">);</span> </span>
<span id="cb3-370"><a href="#cb3-370" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-371"><a href="#cb3-371" aria-hidden="true" tabindex="-1"></a>  <span class="co">// make teperay variabel</span></span>
<span id="cb3-372"><a href="#cb3-372" aria-hidden="true" tabindex="-1"></a>  mat tem_parameters<span class="op">=</span>parameters<span class="op">;</span></span>
<span id="cb3-373"><a href="#cb3-373" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-374"><a href="#cb3-374" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Make lover bound for parameter</span></span>
<span id="cb3-375"><a href="#cb3-375" aria-hidden="true" tabindex="-1"></a>  <span class="dt">double</span> parameter_min<span class="op">=</span> <span class="fl">0.01</span><span class="op">;</span></span>
<span id="cb3-376"><a href="#cb3-376" aria-hidden="true" tabindex="-1"></a>  vec Sigma_lower_bound_vec<span class="op">(</span>Sigma<span class="op">.</span>n_elem<span class="op">,</span>fill<span class="op">::</span>ones<span class="op">);</span></span>
<span id="cb3-377"><a href="#cb3-377" aria-hidden="true" tabindex="-1"></a>  Sigma_lower_bound_vec<span class="op">=</span>parameter_min<span class="op">*</span>Sigma_lower_bound_vec<span class="op">;</span></span>
<span id="cb3-378"><a href="#cb3-378" aria-hidden="true" tabindex="-1"></a>  vec Nu_lower_bound_vec<span class="op">(</span>Nu<span class="op">.</span>n_elem<span class="op">,</span>fill<span class="op">::</span>ones<span class="op">);</span></span>
<span id="cb3-379"><a href="#cb3-379" aria-hidden="true" tabindex="-1"></a>  Nu_lower_bound_vec<span class="op">=</span>parameter_min<span class="op">*</span>Nu_lower_bound_vec<span class="op">;</span></span>
<span id="cb3-380"><a href="#cb3-380" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-381"><a href="#cb3-381" aria-hidden="true" tabindex="-1"></a>  <span class="co">// loop throug gradient decent</span></span>
<span id="cb3-382"><a href="#cb3-382" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i<span class="op">=</span><span class="dv">0</span><span class="op">;</span>i<span class="op">&lt;</span>Max_iter<span class="op">;++</span>i<span class="op">){</span></span>
<span id="cb3-383"><a href="#cb3-383" aria-hidden="true" tabindex="-1"></a>    <span class="co">// make check for gradient size </span></span>
<span id="cb3-384"><a href="#cb3-384" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>norm<span class="op">(</span>vectorise<span class="op">(</span>gradient<span class="op">(</span>X<span class="op">,</span>Pi<span class="op">,</span>parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">0</span><span class="op">),</span>parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">1</span><span class="op">),</span>parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">2</span><span class="op">),</span><span class="st">"no_normaliztion"</span><span class="op">)),</span><span class="dv">2</span><span class="op">)&lt;</span>norm_gradient<span class="op">){</span></span>
<span id="cb3-385"><a href="#cb3-385" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> parameters<span class="op">;</span></span>
<span id="cb3-386"><a href="#cb3-386" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb3-387"><a href="#cb3-387" aria-hidden="true" tabindex="-1"></a>    <span class="co">//graident clipping prcedorure</span></span>
<span id="cb3-388"><a href="#cb3-388" aria-hidden="true" tabindex="-1"></a>    <span class="co">//mat Gradient_clipping_vec(mat gradient,vec C_levels=vec(3,1.0))</span></span>
<span id="cb3-389"><a href="#cb3-389" aria-hidden="true" tabindex="-1"></a>    gradient_in_point<span class="op">=</span>Gradient_clipping_vec<span class="op">(</span>gradient_in_point<span class="op">,</span>Clipping_vector<span class="op">);</span></span>
<span id="cb3-390"><a href="#cb3-390" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-391"><a href="#cb3-391" aria-hidden="true" tabindex="-1"></a>    <span class="co">//check if gradient result in small likelyhood.</span></span>
<span id="cb3-392"><a href="#cb3-392" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span><span class="op">(</span><span class="dt">int</span> j<span class="op">=</span><span class="dv">0</span><span class="op">;</span>j<span class="op">&lt;</span>max_it_in_check<span class="op">;</span>j<span class="op">++){</span></span>
<span id="cb3-393"><a href="#cb3-393" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span><span class="op">(</span>likelyhood_t_mix<span class="op">(</span>X<span class="op">,</span>Pi<span class="op">,</span>parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">0</span><span class="op">),</span>parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">1</span><span class="op">),</span>parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">2</span><span class="op">))&lt;</span>likelyhood_t_mix<span class="op">(</span>X<span class="op">,</span>Pi<span class="op">,</span>tem_parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">0</span><span class="op">),</span>tem_parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">1</span><span class="op">),</span>tem_parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">2</span><span class="op">))){</span></span>
<span id="cb3-394"><a href="#cb3-394" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb3-395"><a href="#cb3-395" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb3-396"><a href="#cb3-396" aria-hidden="true" tabindex="-1"></a>      tem_parameters<span class="op">=</span>parameters<span class="op">-</span>alpha<span class="op">*</span>gradient_in_point<span class="op">;</span></span>
<span id="cb3-397"><a href="#cb3-397" aria-hidden="true" tabindex="-1"></a>      gradient_in_point<span class="op">=</span>alpha<span class="op">*</span>gradient_in_point<span class="op">;</span> <span class="co">// this contiues aplies alpha to the graiden </span></span>
<span id="cb3-398"><a href="#cb3-398" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb3-399"><a href="#cb3-399" aria-hidden="true" tabindex="-1"></a>    parameters<span class="op">=</span>tem_parameters<span class="op">;</span></span>
<span id="cb3-400"><a href="#cb3-400" aria-hidden="true" tabindex="-1"></a>    <span class="co">// If undershoot set to minimum Note is is importante that the check is done before the gradient is updated, otherwise the gradient will not be able to be evaluated</span></span>
<span id="cb3-401"><a href="#cb3-401" aria-hidden="true" tabindex="-1"></a>    parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">1</span><span class="op">)=</span>Maximum_of_two_vector<span class="op">(</span>parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">1</span><span class="op">),</span>Sigma_lower_bound_vec<span class="op">);</span></span>
<span id="cb3-402"><a href="#cb3-402" aria-hidden="true" tabindex="-1"></a>    parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">2</span><span class="op">)=</span>Maximum_of_two_vector<span class="op">(</span>parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">2</span><span class="op">),</span>Nu_lower_bound_vec<span class="op">);</span></span>
<span id="cb3-403"><a href="#cb3-403" aria-hidden="true" tabindex="-1"></a>    <span class="co">// update parametes</span></span>
<span id="cb3-404"><a href="#cb3-404" aria-hidden="true" tabindex="-1"></a>    gradient_in_point <span class="op">=</span> gradient<span class="op">(</span>X<span class="op">,</span>Pi<span class="op">,</span>parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">0</span><span class="op">),</span>parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">1</span><span class="op">),</span>parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">2</span><span class="op">),</span><span class="st">"no_normaliztion"</span><span class="op">);</span></span>
<span id="cb3-405"><a href="#cb3-405" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-406"><a href="#cb3-406" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb3-407"><a href="#cb3-407" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> parameters<span class="op">;</span></span>
<span id="cb3-408"><a href="#cb3-408" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb3-409"><a href="#cb3-409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-410"><a href="#cb3-410" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-411"><a href="#cb3-411" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-412"><a href="#cb3-412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-413"><a href="#cb3-413" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-414"><a href="#cb3-414" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-415"><a href="#cb3-415" aria-hidden="true" tabindex="-1"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb3-416"><a href="#cb3-416" aria-hidden="true" tabindex="-1"></a>mat optimize_using_gradient_decent<span class="op">(</span>vec X<span class="op">,</span></span>
<span id="cb3-417"><a href="#cb3-417" aria-hidden="true" tabindex="-1"></a>                                   vec Pi<span class="op">,</span></span>
<span id="cb3-418"><a href="#cb3-418" aria-hidden="true" tabindex="-1"></a>                                   vec mu<span class="op">,</span></span>
<span id="cb3-419"><a href="#cb3-419" aria-hidden="true" tabindex="-1"></a>                                   vec Sigma<span class="op">,</span></span>
<span id="cb3-420"><a href="#cb3-420" aria-hidden="true" tabindex="-1"></a>                                   vec Nu<span class="op">,</span></span>
<span id="cb3-421"><a href="#cb3-421" aria-hidden="true" tabindex="-1"></a>                                   <span class="dt">double</span> alpha<span class="op">=</span><span class="fl">0.02</span><span class="op">,</span></span>
<span id="cb3-422"><a href="#cb3-422" aria-hidden="true" tabindex="-1"></a>                                   <span class="dt">int</span> Max_iter<span class="op">=</span><span class="dv">1000</span><span class="op">,</span></span>
<span id="cb3-423"><a href="#cb3-423" aria-hidden="true" tabindex="-1"></a>                                   <span class="dt">double</span> norm_gradient <span class="op">=</span> <span class="fl">0.5</span><span class="op">,</span></span>
<span id="cb3-424"><a href="#cb3-424" aria-hidden="true" tabindex="-1"></a>                                   string normalise_method <span class="op">=</span><span class="st">"no_normaliztion"</span><span class="op">,</span><span class="co">//this should be changed</span></span>
<span id="cb3-425"><a href="#cb3-425" aria-hidden="true" tabindex="-1"></a>                                   <span class="dt">bool</span> Check_gradient_decrease <span class="op">=</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb3-426"><a href="#cb3-426" aria-hidden="true" tabindex="-1"></a>                                   <span class="dt">int</span> max_it_in_check<span class="op">=</span> <span class="dv">100</span><span class="op">){</span></span>
<span id="cb3-427"><a href="#cb3-427" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span><span class="op">(</span>Check_gradient_decrease<span class="op">==</span><span class="kw">false</span><span class="op">){</span></span>
<span id="cb3-428"><a href="#cb3-428" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span><span class="op">(</span>gradient_decent_no_check<span class="op">(</span>X<span class="op">,</span>Pi<span class="op">,</span>mu<span class="op">,</span>Sigma<span class="op">,</span>Nu<span class="op">,</span>alpha<span class="op">,</span>Max_iter<span class="op">,</span>norm_gradient<span class="op">,</span>normalise_method<span class="op">));</span></span>
<span id="cb3-429"><a href="#cb3-429" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb3-430"><a href="#cb3-430" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span><span class="op">{</span></span>
<span id="cb3-431"><a href="#cb3-431" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span><span class="op">(</span>gradient_decent_with_check<span class="op">(</span>X<span class="op">,</span>Pi<span class="op">,</span>mu<span class="op">,</span>Sigma<span class="op">,</span>Nu<span class="op">,</span>alpha<span class="op">,</span>Max_iter<span class="op">,</span>norm_gradient<span class="op">,</span>normalise_method<span class="op">,</span>max_it_in_check<span class="op">));</span></span>
<span id="cb3-432"><a href="#cb3-432" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb3-433"><a href="#cb3-433" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-434"><a href="#cb3-434" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb3-435"><a href="#cb3-435" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-436"><a href="#cb3-436" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-437"><a href="#cb3-437" aria-hidden="true" tabindex="-1"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb3-438"><a href="#cb3-438" aria-hidden="true" tabindex="-1"></a>mat EM_t_distribution<span class="op">(</span>vec X<span class="op">,</span></span>
<span id="cb3-439"><a href="#cb3-439" aria-hidden="true" tabindex="-1"></a>                      vec Pi<span class="op">,</span></span>
<span id="cb3-440"><a href="#cb3-440" aria-hidden="true" tabindex="-1"></a>                      vec mu<span class="op">,</span></span>
<span id="cb3-441"><a href="#cb3-441" aria-hidden="true" tabindex="-1"></a>                      vec Sigma<span class="op">,</span></span>
<span id="cb3-442"><a href="#cb3-442" aria-hidden="true" tabindex="-1"></a>                      vec Nu<span class="op">,</span></span>
<span id="cb3-443"><a href="#cb3-443" aria-hidden="true" tabindex="-1"></a>                      vec Clipping_vector<span class="op">,</span></span>
<span id="cb3-444"><a href="#cb3-444" aria-hidden="true" tabindex="-1"></a>                      <span class="dt">int</span> Max_iter <span class="op">=</span> <span class="dv">10000</span><span class="op">,</span></span>
<span id="cb3-445"><a href="#cb3-445" aria-hidden="true" tabindex="-1"></a>                      <span class="dt">double</span> alpha<span class="op">=</span><span class="fl">0.02</span><span class="op">,</span></span>
<span id="cb3-446"><a href="#cb3-446" aria-hidden="true" tabindex="-1"></a>                      <span class="dt">int</span> max_iter_gradient<span class="op">=</span><span class="dv">100</span><span class="op">,</span></span>
<span id="cb3-447"><a href="#cb3-447" aria-hidden="true" tabindex="-1"></a>                      <span class="dt">double</span> norm_gradient <span class="op">=</span> <span class="fl">0.001</span></span>
<span id="cb3-448"><a href="#cb3-448" aria-hidden="true" tabindex="-1"></a><span class="op">){</span></span>
<span id="cb3-449"><a href="#cb3-449" aria-hidden="true" tabindex="-1"></a>  mat parameters<span class="op">(</span>Pi<span class="op">.</span>n_elem<span class="op">,</span><span class="dv">4</span><span class="op">);</span> </span>
<span id="cb3-450"><a href="#cb3-450" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Set parameters value in matrix form (esay to update)</span></span>
<span id="cb3-451"><a href="#cb3-451" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-452"><a href="#cb3-452" aria-hidden="true" tabindex="-1"></a>  parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">0</span><span class="op">)=</span>mu<span class="op">;</span></span>
<span id="cb3-453"><a href="#cb3-453" aria-hidden="true" tabindex="-1"></a>  parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">1</span><span class="op">)=</span>Sigma<span class="op">;</span></span>
<span id="cb3-454"><a href="#cb3-454" aria-hidden="true" tabindex="-1"></a>  parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">2</span><span class="op">)=</span>Nu<span class="op">;</span></span>
<span id="cb3-455"><a href="#cb3-455" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-456"><a href="#cb3-456" aria-hidden="true" tabindex="-1"></a>  mat w_x<span class="op">=</span>Weights_of_X<span class="op">(</span>X<span class="op">,</span>Pi<span class="op">,</span>mu<span class="op">,</span>Sigma<span class="op">,</span>Nu<span class="op">);</span></span>
<span id="cb3-457"><a href="#cb3-457" aria-hidden="true" tabindex="-1"></a>  parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">3</span><span class="op">)=</span>get_Pi<span class="op">(</span>w_x<span class="op">);</span></span>
<span id="cb3-458"><a href="#cb3-458" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i<span class="op">=</span><span class="dv">0</span><span class="op">;</span>i<span class="op">&lt;</span>Max_iter<span class="op">;++</span>i<span class="op">){</span></span>
<span id="cb3-459"><a href="#cb3-459" aria-hidden="true" tabindex="-1"></a>    w_x<span class="op">=</span>Weights_of_X<span class="op">(</span>X<span class="op">,</span>parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">3</span><span class="op">),</span>parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">0</span><span class="op">),</span>parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">1</span><span class="op">),</span>parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">2</span><span class="op">));</span></span>
<span id="cb3-460"><a href="#cb3-460" aria-hidden="true" tabindex="-1"></a>    parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">3</span><span class="op">)=</span>get_Pi<span class="op">(</span>w_x<span class="op">);</span></span>
<span id="cb3-461"><a href="#cb3-461" aria-hidden="true" tabindex="-1"></a>    parameters<span class="op">.</span>cols<span class="op">(</span><span class="dv">0</span><span class="op">,</span><span class="dv">2</span><span class="op">)=</span>gradient_decent_with_clipping<span class="op">(</span>X<span class="op">,</span>parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">3</span><span class="op">),</span>parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">0</span><span class="op">),</span>parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">1</span><span class="op">),</span>parameters<span class="op">.</span>col<span class="op">(</span><span class="dv">2</span><span class="op">),</span>Clipping_vector<span class="op">,</span>alpha<span class="op">,</span>Max_iter<span class="op">,</span>norm_gradient<span class="op">,</span>max_iter_gradient<span class="op">);</span></span>
<span id="cb3-462"><a href="#cb3-462" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb3-463"><a href="#cb3-463" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-464"><a href="#cb3-464" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> parameters<span class="op">;</span></span>
<span id="cb3-465"><a href="#cb3-465" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<details>
<p>Code for visulsations.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">#code for visualasation</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'ggplot2' was built under R version 4.4.2</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>Plot_mix_t_distribution <span class="ot">&lt;-</span> <span class="cf">function</span>(X,Pi,Mu,Sigma,Nu,<span class="at">bins=</span><span class="dv">30</span>){</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  plot_fun<span class="ot">&lt;-</span><span class="cf">function</span>(x){<span class="fu">sapply</span>(x,<span class="cf">function</span>(x){<span class="fu">Mix_T_density_x</span>(x,Pi,Mu,Sigma,Nu)})}</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  plot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="fu">data.frame</span>(X), <span class="fu">aes</span>(<span class="at">x =</span> X)) <span class="sc">+</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">y =</span> ..density..), <span class="at">bins =</span> bins, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stat_function</span>(<span class="at">fun =</span> plot_fun, <span class="at">geom =</span> <span class="st">"line"</span>,<span class="at">color=</span><span class="st">"red"</span>)<span class="sc">+</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Histogram with Mixture of t-Distributions"</span>, <span class="at">x =</span> <span class="st">"X"</span>, <span class="at">y =</span> <span class="st">"Density"</span>) <span class="sc">+</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>()  </span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(plot)</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</details></details></section>
<section id="test" class="level1">
<h1>Test</h1>
<p>Below, I have created a small test of the application with a mixture of three well-separated distributions.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># test</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>draws<span class="ot">=</span><span class="fu">Draw_mixture_componet</span>()</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>model<span class="ot">&lt;-</span><span class="fu">EM_Mix_T_Dist</span>(draws,<span class="at">K=</span><span class="dv">3</span>)</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="fu">Plot_mix_t_distribution</span>(draws,model<span class="sc">$</span>Pi,model<span class="sc">$</span>Mu,model<span class="sc">$</span>Sigma,model<span class="sc">$</span>Nu,<span class="at">bins=</span><span class="dv">50</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Mixture-of-K-scaled-and-shifted-t-distributions_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>As can be seen, the application performs very well.</p>
</section>
<section id="a-look-into-when-initialization-fails" class="level1">
<h1>A Look into When Initialization Fails</h1>
<p>The initialization of the distribusion is too close together, as illustrated below.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">3123</span>)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>draws<span class="ot">=</span><span class="fu">Draw_mixture_componet</span>(<span class="at">Mu=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="dv">4</span>,<span class="dv">10</span>))</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>model<span class="ot">&lt;-</span><span class="fu">EM_Mix_T_Dist</span>(draws,<span class="at">K=</span><span class="dv">3</span>)</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="fu">Plot_mix_t_distribution</span>(draws,model<span class="sc">$</span>Pi,model<span class="sc">$</span>Mu,model<span class="sc">$</span>Sigma,model<span class="sc">$</span>Nu,<span class="at">bins=</span><span class="dv">50</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 101 rows containing missing values or values outside the scale range
(`geom_line()`).</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Mixture-of-K-scaled-and-shifted-t-distributions_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Above, I have drawn from a mixture model with three components and fitted a three-component mixture model using automated initialization, even though there are three distinct peaks. The initialization fails.</p>
<p>Below, there is a second example, again with three components, but in this case, it is not easy to tell if there are two or three components.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Make </span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>draws<span class="ot">=</span><span class="fu">Draw_mixture_componet</span>(<span class="at">Mu=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">2</span>,<span class="dv">10</span>))</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(draws,<span class="at">breaks =</span> <span class="dv">100</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Mixture-of-K-scaled-and-shifted-t-distributions_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>KMeans_objet<span class="ot">=</span><span class="fu">KMeans_rcpp</span>(<span class="fu">as.matrix</span>(draws), <span class="at">clusters =</span> <span class="dv">3</span>, <span class="at">num_init =</span> <span class="dv">90</span>, <span class="at">initializer =</span> <span class="st">'kmeans++'</span>)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">3</span>))</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(draws[KMeans_objet<span class="sc">$</span>clusters<span class="sc">==</span><span class="dv">1</span>],<span class="at">breaks =</span> <span class="dv">30</span>)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(draws[KMeans_objet<span class="sc">$</span>clusters<span class="sc">==</span><span class="dv">2</span>],<span class="at">breaks =</span> <span class="dv">30</span>)</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(draws[KMeans_objet<span class="sc">$</span>clusters<span class="sc">==</span><span class="dv">3</span>],<span class="at">breaks =</span> <span class="dv">30</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Mixture-of-K-scaled-and-shifted-t-distributions_files/figure-html/unnamed-chunk-7-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="co">#if one runs the stadart implentasion here the starting guase would fail.</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co">#model&lt;-EM_Mix_T_Dist(draws,K=3)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>In the above, the histograms of the fractions generated from the K-means++ are shown. Cluster 1 is the well-separated cluster. The rest of the partitions do not resemble a T-distribution, which seems to lead to the high values of <span class="math inline">\(\nu\)</span></p>
<p>The above is generated from mixing three t-distributions but could look like two distributions. My implementation for standardization will, in this case, fail. It will return since the value of gradient becomes to high do to large value of <span class="math inline">\(\nu\)</span>.</p>
<p>Below, I showcase how one can manually tune the input and run the method.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>Pi_test<span class="ot">=</span><span class="fu">Estiame_Pi_from_partions</span>(KMeans_objet<span class="sc">$</span>clusters,<span class="at">K=</span><span class="dv">3</span>)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>mu_test<span class="ot">=</span><span class="fu">c</span>(<span class="fu">mean</span>(draws[KMeans_objet<span class="sc">$</span>clusters<span class="sc">==</span><span class="dv">1</span>]),<span class="fu">mean</span>(draws[KMeans_objet<span class="sc">$</span>clusters<span class="sc">==</span><span class="dv">2</span>]),<span class="fu">mean</span>(draws[KMeans_objet<span class="sc">$</span>clusters<span class="sc">==</span><span class="dv">3</span>]))</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="co"># here is to example on how to hand fit the values </span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="fu">Plot_mix_t_distribution</span>(draws,Pi_test,mu_test,<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>),<span class="fu">c</span>(<span class="fl">2.5</span>,<span class="fl">2.5</span>,<span class="dv">4</span>),<span class="at">bins=</span><span class="dv">100</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Mixture-of-K-scaled-and-shifted-t-distributions_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">Plot_mix_t_distribution</span>(draws,<span class="fu">c</span>(<span class="fl">0.2</span>,<span class="fl">0.4</span>,<span class="fl">0.4</span>),mu_test,<span class="fu">c</span>(<span class="dv">1</span>,<span class="fl">1.7</span>,<span class="dv">3</span>),<span class="fu">c</span>(<span class="fl">2.5</span>,<span class="fl">2.5</span>,<span class="dv">4</span>),<span class="at">bins=</span><span class="dv">100</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Mixture-of-K-scaled-and-shifted-t-distributions_files/figure-html/unnamed-chunk-8-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Lastly, we examine what the implementation yields after manual tuning is used as the starting values.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>Pi_test<span class="ot">=</span><span class="fu">Estiame_Pi_from_partions</span>(KMeans_objet<span class="sc">$</span>clusters,<span class="at">K=</span><span class="dv">3</span>)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>mu_test<span class="ot">=</span><span class="fu">c</span>(<span class="fu">mean</span>(draws[KMeans_objet<span class="sc">$</span>clusters<span class="sc">==</span><span class="dv">1</span>]),<span class="fu">mean</span>(draws[KMeans_objet<span class="sc">$</span>clusters<span class="sc">==</span><span class="dv">2</span>]),<span class="fu">mean</span>(draws[KMeans_objet<span class="sc">$</span>clusters<span class="sc">==</span><span class="dv">3</span>]))</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>model<span class="ot">&lt;-</span><span class="fu">EM_Mix_T_Dist</span>(draws,<span class="at">K=</span><span class="dv">3</span>,<span class="at">Pi=</span><span class="fu">c</span>(<span class="fl">0.2</span>,<span class="fl">0.4</span>,<span class="fl">0.4</span>),<span class="at">Mu=</span>mu_test,<span class="at">Sigma=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="fl">1.7</span>,<span class="dv">3</span>),<span class="at">Nu=</span><span class="fu">c</span>(<span class="fl">2.5</span>,<span class="fl">2.5</span>,<span class="dv">4</span>),,<span class="at">Max_iter =</span> <span class="dv">100</span>, <span class="at">max_iter_gradient=</span><span class="dv">3</span>)</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="fu">Plot_mix_t_distribution</span>(draws,model<span class="sc">$</span>Pi,model<span class="sc">$</span>Mu,model<span class="sc">$</span>Sigma,model<span class="sc">$</span>Nu,<span class="at">bins =</span> <span class="dv">100</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Mixture-of-K-scaled-and-shifted-t-distributions_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>As can be seen the Em algorithm still strugels here.</p>
<p>If one runs the implication with <span class="math inline">\(K=2\)</span> their is no problems.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>model<span class="ot">&lt;-</span><span class="fu">EM_Mix_T_Dist</span>(draws,<span class="at">K=</span><span class="dv">2</span>)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="fu">Plot_mix_t_distribution</span>(draws,model<span class="sc">$</span>Pi,model<span class="sc">$</span>Mu,model<span class="sc">$</span>Sigma,model<span class="sc">$</span>Nu,<span class="at">bins =</span> <span class="dv">100</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Mixture-of-K-scaled-and-shifted-t-distributions_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<section id="test-with-second-initialization" class="level2">
<h2 class="anchored" data-anchor-id="test-with-second-initialization">Test with second initialization</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">3123</span>)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>draws<span class="ot">=</span><span class="fu">Draw_mixture_componet</span>(<span class="at">Mu=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="dv">4</span>,<span class="dv">10</span>))</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>model<span class="ot">&lt;-</span><span class="fu">EM_Mix_T_Dist</span>(draws,<span class="at">K=</span><span class="dv">3</span>,<span class="at">Start_method_optim =</span> F)</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="fu">Plot_mix_t_distribution</span>(draws,model<span class="sc">$</span>Pi,model<span class="sc">$</span>Mu,model<span class="sc">$</span>Sigma,model<span class="sc">$</span>Nu,<span class="at">bins=</span><span class="dv">50</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Mixture-of-K-scaled-and-shifted-t-distributions_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The method based on the grid search is computational expensiv but can give good result.</p>
</section>
<section id="why-the-initialization-fails." class="level2">
<h2 class="anchored" data-anchor-id="why-the-initialization-fails.">Why the initialization fails.</h2>
<p>If the starting values are too extreme, such as <span class="math inline">\(\nu_i=50000\)</span>, the gradient cannot be computed properly due to issues with the gamma function or its derivative. As it stands, the initialization can produce such problematic values if the data from k-means is not well-behaved. If the distribution is not well-separated, the hard clustering technique will not capture enough of the distribution in the decreasing part as the function moves out. This can lead to excessively high values of <span class="math inline">\(\nu\)</span>.</p>
</section>
</section>
<section id="aplicantion-on-real-data" class="level1">
<h1>Aplicantion on real data</h1>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mixsmsn)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the dataset</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>data_real_test<span class="ot">&lt;-</span><span class="fu">as.vector</span>( <span class="fu">unlist</span>(faithful<span class="sc">$</span>eruptions))</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>paramenter<span class="ot">=</span><span class="fu">Intiall_parameter_grid</span>(data_real_test,<span class="at">Pi=</span><span class="cn">NA</span>,<span class="at">Mu=</span><span class="cn">NA</span>,<span class="at">Sigma=</span><span class="fu">seq</span>(<span class="fl">0.1</span>,<span class="dv">4</span>,<span class="fl">0.5</span>),<span class="at">Nu=</span><span class="fu">seq</span>(<span class="dv">1</span>,<span class="dv">3</span>,<span class="fl">0.5</span>),<span class="at">K=</span><span class="dv">2</span>)</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>model<span class="ot">&lt;-</span><span class="fu">EM_Mix_T_Dist</span>(data_real_test,<span class="at">Pi=</span>paramenter<span class="sc">$</span>Pi,<span class="at">Mu=</span>paramenter<span class="sc">$</span>Mu,<span class="at">Sigma =</span> paramenter<span class="sc">$</span>Sigma,<span class="at">Nu=</span>paramenter<span class="sc">$</span>Nu,<span class="at">K=</span><span class="dv">2</span>,<span class="at">max_iter_gradient =</span> <span class="dv">40</span>,<span class="at">Max_iter =</span><span class="dv">200</span> )</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a><span class="fu">Plot_mix_t_distribution</span>(data_real_test,model<span class="sc">$</span>Pi,model<span class="sc">$</span>Mu,model<span class="sc">$</span>Sigma,model<span class="sc">$</span>Nu,<span class="at">bins=</span><span class="dv">50</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Mixture-of-K-scaled-and-shifted-t-distributions_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Above, I have applied the method to real-world data from the Old Faithful geyser in Yellowstone National Park. The y-axis represents the eruption height. I had to manually feed the grid optimization into the function to get some decent starting values, and I had to run the application more times than the standard, but overall, the method works.</p>
<p>Pro-tip: Potentially, one can speed up the process by hand-tuning the grid search.</p>
</section>
<section id="further-improvements" class="level1">
<h1>Further improvements</h1>
<section id="model-selection" class="level2">
<h2 class="anchored" data-anchor-id="model-selection">Model selection</h2>
<p>Further improvements should be made to the initialization process, as this would enable automatic model selection based on AIC or BIC.</p>
</section>
<section id="confidence-bands" class="level2">
<h2 class="anchored" data-anchor-id="confidence-bands">confidence bands</h2>
<p>Implementing confidence bands using a parametric bootstrap approach would be beneficial. Their is small complication since <span class="math inline">\(\pi_i\)</span> label ambiguity. For faster implementation, the bootstrap process could utilize a “hot start,” meaning setting the starting values for the parameters to the estimated values.</p>
<section id="initialization-1" class="level3">
<h3 class="anchored" data-anchor-id="initialization-1">Initialization</h3>
<p>The initialization could run in parallel for both the grid search and the optimization method. It seems like R won’t import functions defined in a separate Rcpp file to the cluster. There are two options: define the necessary functions and dependent functions directly in R via the RcppFunction, or do the parallelization in Rcpp. Doing the parallelization directly in Rcpp would be better.</p>
</section>
<section id="gradient-decent.-1" class="level3">
<h3 class="anchored" data-anchor-id="gradient-decent.-1">Gradient decent.</h3>
<p>It would be nice if the gradient descent could use more iterations in the later steps. This is fairly easy to implement, but for an end-user and for me, it’s hard to set a good standard setting. Potentially, some of the same effect can be achieved by increasing the number of iterations since if the weights don’t change, it would almost be the same.</p>
<p>For now the project is closed.</p>


</section>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>